/*
 (c) Iasi Digital [https://iasi.digital]
*/
const publicParking=(()=>{function c(a=null){return app.fetch({url:app.config.url,method:"POST",postFields:{action:"fetch",type:"api",value:"64dc-92f1-4b56-9071-1313/22d1082403b780c66b2687f43de783a10c16"},callback:b=>{app.dataSets.publicParking.data.places=b;app.dataSets.publicParking.updated=Date.now();a&&a()}})}function d(a,b=null){null!==app.dataSets.publicParking.watcher&&(clearInterval(app.dataSets.publicParking.watcher),app.dataSets.publicParking.watcher=null);app.dataSets.publicParking.watcher=
setInterval(()=>{null!==b&&b()},a)}function e(){void 0===app.dataSets.publicParking.data.places?c(()=>{e()}):app.dataSets.publicParking.data.places.forEach(a=>{void 0===app.dataSets.publicParking.markers[a.sensorId]?(app.dataSets.publicParking.markers[a.sensorId]={id:a.sensorId,parking:a.parkingId,state:a.stare,ref:new google.maps.Marker({position:{lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},map:app.map.ref,title:a.numar.toString(),optimized:!0,icon:{url:`${app.cdn}pin/public-parking/${a.stare}.png`,
size:new google.maps.Size(22,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(11,35),scaledSize:new google.maps.Size(22,35)}}),lastUpdate:Date.now(),visible:!0,popup:`<div id="mapPopup"><header><span class="label parking parking-${a.stare} ic-mr-10">P</span><h5>${1===parseInt(a.stare)?"Liber":2===parseInt(a.stare)?"Ocupat":"Rezervat"}</h5></header><main><ul><li><strong>Num\u0103r loc parcare</strong>: ${a.numar}</li><li><strong>Parcare</strong>: ${h[a.parkingId]}</li></ul>${1===
parseInt(a.stare)?`<nav><button class="btn btn-render-direction" data-lat="${parseFloat(a.latitude)}" data-lng="${parseFloat(a.longitude)}">Afi\u0219eaz\u0103 rut\u0103 <span data-icon="&#xe018;" class="ic-ml-5"></span></button></nav>`:""}</main></div>`},app.dataSets.publicParking.markers[a.sensorId].ref.addListener("click",()=>{app.map.popup&&(app.map.popup.close(),app.dataSets.publicParking.selectedMarker=null,app.events.fire("clearDirectionService"));app.dataSets.publicParking.selectedMarker=app.dataSets.publicParking.markers[a.sensorId].ref;
app.map.popup=new google.maps.InfoWindow({content:app.dataSets.publicParking.markers[a.sensorId].popup});app.map.popup.open(app.map.ref,app.dataSets.publicParking.selectedMarker);google.maps.event.addListener(app.map.popup,"domready",()=>{const b=document.querySelector(".btn-render-direction");b&&b.addEventListener("click",f=>{f=parseFloat(b.getAttribute("data-lat"))||0;let k=parseFloat(b.getAttribute("data-lng"))||0;try{null===app.map.direction.service&&app.events.fire("initiateDirectionService"),
(0===app.me.location.lat||0===app.me.location.lng&&app.config.messages["route.error.unableToDetermine"])&&app.notify(app.config.messages["route.error.unableToDetermine"],"error",10),(0===f||0===k&&app.config.messages["parking.error.unableToDetermineLocation"])&&app.notify(app.config.messages["parking.error.unableToDetermineLocation"],"error",10),app.map.direction.service.route({origin:new google.maps.LatLng(app.me.location.lat,app.me.location.lng),destination:new google.maps.LatLng(f,k),travelMode:"DRIVING"},
function(g,l){"OK"===l&&app.map.direction.renderer.setDirections(g)})}catch(g){app.notify(g,"error",10)}})})})):(app.dataSets.publicParking.markers[a.sensorId].state=a.stare,app.dataSets.publicParking.markers[a.sensorId].lastUpdate=Date.now(),app.dataSets.publicParking.markers[a.sensorId].popup=`<div id="mapPopup"><header><span class="label parking parking-${a.stare} ic-mr-10">P</span><h5>${1===parseInt(a.stare)?"Liber":2===parseInt(a.stare)?"Ocupat":"Rezervat"}</h5></header><main><ul><li><strong>Num\u0103r loc parcare</strong>: ${a.numar}</li><li><strong>Parcare</strong>: ${h[a.parkingId]}</li></ul>${1===
parseInt(a.stare)?`<nav><button class="btn btn-render-direction" data-lat="${parseFloat(a.latitude)}" data-lng="${parseFloat(a.longitude)}">Afi\u0219eaz\u0103 rut\u0103 <span data-icon="&#xe018;" class="ic-ml-5"></span></button></nav>`:""}</main></div>`)})}const h={82:"Moldova",83:"Mitoc",84:"Prim\u0103ria Ia\u0219i",85:"Prefectura Ia\u0219i",86:"Prim\u0103verii",87:"Podu Ro\u0219u",88:"Teatru",89:"Victoria",90:"Hala Central\u0103",91:"Independen\u021bei",92:"Golia",93:"Casa Studen\u021bilor",94:"Anastasie Panu"};
return{init:function(){d(18E4,()=>{c()})},getData:c,show:function(){e();d(9E4,()=>{c(()=>{e()})});app.dataSets.publicParking.visible=!0},hide:function(){d(18E4,()=>{c()});Object.values(app.dataSets.publicParking.markers).forEach(a=>{a.ref&&a.ref.setMap(null)});app.dataSets.publicParking.markers=[];app.dataSets.publicParking.visible=!1;app.events.fire("clearDirectionService")}}})();(()=>{app.dataSets.publicParking.app=publicParking})();
