/*
 (c) 2023. Iasi Digital [https://iasi.digital]
*/
const publicTransportation=(()=>{function d(a=null){app.api("https://opendata.oras.digital/public-api/proxy/","POST",{action:"fetch",type:"api",value:"dc2a-cd0a-477f-95f3-1107"}).then(b=>b.ok?b.json():!1).then(b=>{app.dataSets.publicTransportation.data.vehicles=b;app.dataSets.publicTransportation.updated=Date.now();null!==a&&a()}).catch(b=>!1);return!0}function g(a=null){app.api("https://opendata.oras.digital/public-api/proxy/","POST",{action:"fetch",type:"api",value:"74eb-a3f3-436b-aa5f-0c2a/816b8cdb6dc7997cbbe0cb9e1b2969727406"}).then(b=>
b.ok?b.json():!1).then(b=>{app.dataSets.publicTransportation.data.routes={};b.forEach(c=>{app.dataSets.publicTransportation.data.routes[c.route_id]={name:c.route_short_name,long:c.route_long_name,type:c.route_type}});null!==a&&a()}).catch(b=>!1);return!0}function e(a,b=null){null!==app.dataSets.publicTransportation.watcher&&(clearInterval(app.dataSets.publicTransportation.watcher),app.dataSets.publicTransportation.watcher=null);app.dataSets.publicTransportation.watcher=setInterval(()=>{null!==b&&
b()},a)}function f(){void 0===app.dataSets.publicTransportation.data.routes&&g();void 0===app.dataSets.publicTransportation.data.vehicles?d(()=>{f()}):app.dataSets.publicTransportation.data.vehicles.forEach(a=>{let b=app.dateDiff(a.timestamp);if(a.latitude&&a.longitude&&a.route_id&&void 0!==app.dataSets.publicTransportation.data.routes[a.route_id]&&60>b){let c=app.dataSets.publicTransportation.data.routes[a.route_id].name,h=app.dataSets.publicTransportation.data.routes[a.route_id].long,k=app.dataSets.publicTransportation.data.routes[a.route_id].type;
app.dataSets.publicTransportation.markers[a.label]?(app.dataSets.publicTransportation.markers[a.label].ref.setPosition(new google.maps.LatLng(a.latitude,a.longitude)),app.dataSets.publicTransportation.markers[a.label].lastUpdate=a.timestamp,app.dataSets.publicTransportation.markers[a.label].popup=`<div id="mapPopup"><header>${null!==c?`<span class="label route route-${18<=parseInt(c)?"bus":`line-${c}`} ic-mr-10">${c}</span>`:""}<h5>${h}</h5></header><main><ul><li><strong>Ultima actualizare</strong>: acum ${b} minute</li><li><strong>Cod identificare</strong>: ${a.label}</li><li><strong>Vitez\u0103</strong>: ${a.speed} km/h</li></ul></main></div>`):
(app.dataSets.publicTransportation.markers[a.label]={id:a.label,type:k,route:c,ref:new google.maps.Marker({position:{lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},map:app.map.ref,title:a.route_id.toString(),optimized:!0,icon:{url:`${app.cdn}pin/mobility/public-transportation/${null!==c?`${c}.png`:`${0===k?"tram":"bus"}.png`}`,size:new google.maps.Size(28,44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,44),scaledSize:new google.maps.Size(28,44)}}),lastUpdate:a.timestamp,
visible:!0,popup:`<div id="mapPopup"><header>${null!==c?`<span class="label route route-${18<=parseInt(c)?"bus":`line-${c}`} ic-mr-10">${c}</span>`:""}<h5>${h}</h5></header><main><ul><li><strong>Ultima actualizare</strong>: acum ${app.dateDiff(a.timestamp)} minute</li><li><strong>Cod identificare</strong>: ${a.label}</li><li><strong>Vitez\u0103</strong>: ${a.speed} km/h</li></ul></main></div>`},app.dataSets.publicTransportation.markers[a.label].ref.addListener("click",()=>{app.map.popup&&(app.map.popup.close(),
app.dataSets.publicTransportation.selectedMarker=null);app.dataSets.publicTransportation.selectedMarker=app.dataSets.publicTransportation.markers[a.label].ref;app.map.popup=new google.maps.InfoWindow({content:app.dataSets.publicTransportation.markers[a.label].popup});app.map.popup.open(app.map.ref,app.dataSets.publicTransportation.selectedMarker)}))}})}return{init:function(){g();e(6E4,()=>{d()})},fetch:d,show:function(){f();e(2E4,()=>{d(()=>{f()})});app.dataSets.publicTransportation.visible=!0},hide:function(){e(6E4,
()=>{d()});Object.values(app.dataSets.publicTransportation.markers).forEach(a=>{a.ref&&a.ref.setMap(null)});app.dataSets.publicTransportation.markers=[];app.dataSets.publicTransportation.visible=!1}}})();(()=>{app.dataSets.publicTransportation.app=publicTransportation})();
