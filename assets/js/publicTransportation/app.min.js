/*
 (c) Iasi Digital [https://iasi.digital]
*/
const publicTransportation=(()=>{function d(a=null){return app.fetch({url:app.config.url,method:"POST",postFields:{action:"fetch",type:"api",value:"dc2a-cd0a-477f-95f3-1107"},callback:b=>{app.dataSets.publicTransportation.data.vehicles=b;app.dataSets.publicTransportation.updated=Date.now();a&&a()}})}function m(){return app.fetch({url:`${app.cdn}js/publicTransportation/routes.json`,callback:a=>{app.dataSets.publicTransportation.data.routes={};a.forEach(b=>{app.dataSets.publicTransportation.data.routes[b.route_id]=
{name:b.route_short_name,long:b.route_long_name,type:b.route_type,color:b.route_color}})}})}function e(a=null){return app.fetch({url:app.config.url,method:"POST",postFields:{action:"fetch",type:"api",value:"dc2a-cd0a-477f-95f3-1107/52cf25d5c64d1f700b8867cee05112525698"},callback:b=>{app.dataSets.publicTransportation.data.trips={};b.forEach(c=>{app.dataSets.publicTransportation.data.trips[c.trip_id]={route:c.route_id,trip:c.trip_id,headSign:c.trip_headsign,direction:c.direction_id,shape:c.shape_id}});
a&&a()}})}function f(a,b=null){null!==app.dataSets.publicTransportation.watcher&&(clearInterval(app.dataSets.publicTransportation.watcher),app.dataSets.publicTransportation.watcher=null);app.dataSets.publicTransportation.watcher=setInterval(()=>{null!==b&&b()},a)}function g(){void 0===app.dataSets.publicTransportation.data.trips&&(e(),setInterval(()=>{e()},12E4));void 0===app.dataSets.publicTransportation.data.vehicles?d(()=>{g()}):app.dataSets.publicTransportation.data.vehicles.forEach(a=>{let b=
app.dateDiff(a.timestamp,!0);if(a.latitude&&a.longitude&&a.route_id&&a.trip_id&&app.dataSets.publicTransportation.data.routes[a.route_id]&&app.dataSets.publicTransportation.data.trips[a.trip_id]&&60>b){let c=app.dataSets.publicTransportation.data.routes[a.route_id].name.trim(),h=app.dataSets.publicTransportation.data.routes[a.route_id].long.trim(),k=app.dataSets.publicTransportation.data.routes[a.route_id].type,l=app.dataSets.publicTransportation.data.trips[a.trip_id].headSign.trim();app.dataSets.publicTransportation.markers[a.label]?
(app.dataSets.publicTransportation.markers[a.label].ref.setPosition(new google.maps.LatLng(a.latitude,a.longitude)),app.dataSets.publicTransportation.markers[a.label].lastUpdate=a.timestamp,app.dataSets.publicTransportation.markers[a.label].popup=`<div id="mapPopup"><header>${null!==c?`<span class="label route route-${c} ic-mr-10">${c}</span>`:""}<h5>${h}</h5></header><main><ul><li><strong>Direc\u021bie</strong>: ${l}</li><li><strong>Ultima actualizare</strong>: acum ${b} minute</li><li><strong>Cod identificare</strong>: ${a.label}</li><li><strong>Vitez\u0103</strong>: ${a.speed} km/h</li></ul></main></div>`):
(app.dataSets.publicTransportation.markers[a.label]={id:a.label,type:k,route:c,ref:new google.maps.Marker({position:{lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},map:app.map.ref,title:a.route_id.toString(),optimized:!0,icon:{url:`${app.cdn}pin/public-transportation/${null!==c?`${c}.png`:`${0===k?"tram":"bus"}.png`}`,size:new google.maps.Size(22,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(11,35),scaledSize:new google.maps.Size(22,35)}}),lastUpdate:a.timestamp,visible:!0,
popup:`<div id="mapPopup"><header>${null!==c?`<span class="label route route-${c} ic-mr-10">${c}</span>`:""}<h5>${h}</h5></header><main><ul><li><strong>Direc\u021bie</strong>: ${l}</li><li><strong>Ultima actualizare</strong>: acum ${b} minute</li><li><strong>Cod identificare</strong>: ${a.label}</li><li><strong>Vitez\u0103</strong>: ${a.speed} km/h</li></ul></main></div>`},app.dataSets.publicTransportation.markers[a.label].ref.addListener("click",()=>{app.map.popup&&(app.map.popup.close(),app.dataSets.publicTransportation.selectedMarker=
null);app.dataSets.publicTransportation.selectedMarker=app.dataSets.publicTransportation.markers[a.label].ref;app.map.popup=new google.maps.InfoWindow({content:app.dataSets.publicTransportation.markers[a.label].popup});app.map.popup.open(app.map.ref,app.dataSets.publicTransportation.selectedMarker);google.maps.event.addListener(app.map.popup,"closeclick",()=>{app.dataSets.publicTransportation.selectedMarker=null;app.map.popup=null})}))}})}return{init:function(){m();e();f(6E4,()=>{d()})},getData:d,
show:function(){g();f(2E4,()=>{d(()=>{g()})});app.dataSets.publicTransportation.visible=!0},hide:function(){f(6E4,()=>{d()});Object.values(app.dataSets.publicTransportation.markers).forEach(a=>{a.ref&&a.ref.setMap(null)});app.dataSets.publicTransportation.markers=[];app.dataSets.publicTransportation.visible=!1}}})();(()=>{app.dataSets.publicTransportation.app=publicTransportation})();
