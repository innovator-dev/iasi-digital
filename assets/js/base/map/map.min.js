/*
 (c) 2024. Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(a,b){this.items[a]||(this.items[a]={name:a,callback:[]});this.items[a].callback.push(b)}fireAll(){for(let a in this.items)this.fire(a)}clearAll(a){this.items[a]={name:a,callback:[]}}fire(a){if(this.items[a])for(let b in this.items[a].callback)this.items[a].callback[b]()}}
class CityApp{static initialize(){this.config={};this.bindConfig();this.data={map:{_ref:null,center:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},dataSets:{}};this.renderMap()}static async api(a,b="GET",d="",f={}){d={method:b,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},f),body:d?JSON.stringify(d):""};"GET"!==b&&"HEAD"!==b||delete d.body;
return await fetch(a,d)}static load(a,b,d){let f=document.getElementsByTagName("script")[0],c=document.createElement("script");void 0!==b&&null!==b&&(c.onreadystatechange=()=>{if("loaded"===c.readyState||"complete"===c.readyState)c.onreadystatechange=null,b(d)},c.onload=()=>{b(d)});c.setAttribute("src",a);c.setAttribute("defer","");f.parentNode.appendChild(c)}static async bindConfig(){const a=document.querySelector("body.page").dataset;a.bind&&(this.config=Object.assign(this.config,JSON.parse(atob(a.bind))));
CityApp.api("config.json").then(b=>b.ok?b.json():!1).then(b=>{this.config=Object.assign(this.config,b)}).catch(b=>{console.error(b)})}static notification(a,b="error",d=0,f=!0){const c=document.querySelector(".notification-floating-placeholder");if(c){const g=c.querySelectorAll(".notification"),e=document.createElement("p");e.classList.add("notification","notification-sm");e.classList.remove("error","success","info","warning");e.classList.add(b);e.innerHTML=a;f?(e.classList.add("notification-floating",
"notification-animation"),0<g.length&&(e.style.bottom=`${45*g.length+20}px`)):0<g.length&&(c.innerHTML="");c.appendChild(e);0<d&&setTimeout(()=>{e.classList.remove("notification","notification-sm","notification-inline","notification-animation","notification-floating","error","success","info","warning");e.innerHTML="";e.parentNode.removeChild(e)},1E3*d)}}static dateDiff(a,b=!1){let d=a.split(/\D/);a=new Date;b&&(a=new Date(a.getTime()+6E4*a.getTimezoneOffset()));b=new Date(d[0],d[1]-1,d[2],d[3],d[4],
d[5]);if(isNaN(a)||isNaN(b))return null;b=Math.abs(a.getTime()-b.getTime());return Math.floor(b/1E3/60)}static getSetData(a){try{if(!a.url&&this.config.messages["apiCall.error.missingUrl"])throw this.config.messages["apiCall.error.missingUrl"];this.api(a.url,a.method||"GET",a.postFields||{}).then(b=>b.ok?b.json():!1).then(b=>{null!==a.callback&&a.callback(b)}).catch(b=>!1);return!0}catch(b){this.notification(b,"error",10)}}static renderMap(){const a=document.querySelector("#map");a&&this.config.map&&
this.load(this.config.map,()=>{this.data.map._ref=new google.maps.Map(a,{center:this.data.map.center,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!0,mapId:"4c67bc89ba82ae84"});google.maps.event.addListenerOnce(this.data.map._ref,"tilesloaded",()=>{this.data.map.loaded=!0;google.maps.importLibrary("marker");this.renderMapControls()})})}static renderMapControls(){const a=document.querySelector(".mapControls");if(a&&this.data.map.loaded){const b=document.createElement("div");b.classList.add("mapControlsContainer");
const d=document.createElement("button");d.classList.add("mapCustomControl");d.innerHTML='<span data-icon="&#xe013;"></span>';d.title=this.config.labels.centerOnCity;d.type="button";d.addEventListener("click",f=>{f.preventDefault();f.stopPropagation();0<this.data.map.center.lat&&0<this.data.map.center.lng&&(this.data.map._ref.panTo(new google.maps.LatLng(this.data.map.center.lat,this.data.map.center.lng)),this.data.map._ref.setZoom(14))});b.appendChild(d);this.data.map._ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(b);
this.data.map.controls={spinner:a.querySelector("h2 .spinner"),publicTransportation:a.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:a.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:a.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:a.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:a.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};
a.classList.remove("hide");a.querySelectorAll(".btn-toggle").forEach(f=>{const c=f.dataset;c.set&&(this.data.dataSets[c.set]={app:{_ref:null,watcher:null,loaded:!1,visible:!1},data:{},dataUpdated:null,markers:[],selectedMarker:null,props:{},getData(g,e){return CityApp.getSetData({url:CityApp.config.url,method:"POST",postFields:{action:"fetch",type:"api",value:g},callback:e})},setWatcher(g,e){null!==this.app.watcher&&(clearInterval(this.app.watcher),this.app.watcher=null);this.app.watcher=setInterval(()=>
{null!==e&&e()},g)}},c.source&&(this.load(c.source,()=>{this.data.dataSets[c.set].app.loaded=!0;this.data.dataSets[c.set].app._ref.getData()?(this.data.dataSets[c.set].hasData=!0,this.data.dataSets[c.set].app._ref.init()):this.data.map.controls[c.set].setAttribute("disabled","disabled")}),f.addEventListener("click",()=>{this.data.map.controls.spinner.classList.remove("hide");this.data.map.controls[c.set].checked?this.data.dataSets[c.set].app._ref.show():this.data.dataSets[c.set].app._ref.hide();this.data.map.controls.spinner.classList.add("hide")})),
"trafficLayer"===c.set&&f.addEventListener("click",()=>{this.data.map.controls.spinner.classList.remove("hide");this.data.map.controls[c.set].checked?(this.data.dataSets[c.set].app._ref=new google.maps.TrafficLayer,this.data.dataSets[c.set].app._ref.setMap(this.data.map._ref),this.data.dataSets[c.set].visible=!0):(this.data.dataSets[c.set].visible=!1,this.data.dataSets[c.set].app._ref.setMap(null),this.data.dataSets[c.set].app._ref=null);this.data.map.controls.spinner.classList.add("hide")}))})}}}
(()=>{CityApp.initialize();window.CityApp=CityApp})();
