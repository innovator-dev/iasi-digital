/*
 (c) Iasi Digital [https://iasi.digital]
*/
const wasteCollection=(()=>{function c(a=null){return app.fetch({url:app.config.url,method:"POST",postFields:{action:"fetch",type:"api",value:"544f-2a7a-490a-ac5c-0f79"},callback:b=>{app.dataSets.wasteCollection.data.vehicles=b;app.dataSets.wasteCollection.updated=Date.now();a&&a()}})}function e(a,b=null){null!==app.dataSets.wasteCollection.watcher&&(clearInterval(app.dataSets.wasteCollection.watcher),app.dataSets.wasteCollection.watcher=null);app.dataSets.wasteCollection.watcher=setInterval(()=>
{null!==b&&b()},a)}function f(){void 0===app.dataSets.wasteCollection.data.vehicles?c(()=>{f()}):0<app.dataSets.wasteCollection.data.vehicles.length&&app.dataSets.wasteCollection.data.vehicles.forEach(a=>{let b=app.dateDiff(a.LastRecordDT);if(a.LastLatitude&&a.LastLongitude)if(app.dataSets.wasteCollection.markers[a.VehicleId])app.dataSets.wasteCollection.markers[a.VehicleId].ref.position={lat:a.LastLatitude,lng:a.LastLongitude},app.dataSets.airQuality.markers[a.VehicleId].lastUpdate=a.LastRecordDT,
app.dataSets.airQuality.markers[a.id].popup=`<div id="mapPopup"><header><h5>${a.PlateNumber}</h5></header><main><ul><li><strong>Ultima actualizare</strong>: acum ${b} minute</li></ul></main></div>`;else{let d=document.createElement("img");d.src=`${app.cdn}pin/waste-collection/vehicle.png`;d.width=22;d.height=35;app.dataSets.wasteCollection.markers[a.VehicleId]={id:a.VehicleId,ref:new google.maps.marker.AdvancedMarkerElement({position:{lat:parseFloat(a.LastLatitude),lng:parseFloat(a.LastLongitude)},
map:app.map.ref,title:a.PlateNumber,content:d}),lastUpdate:a.LastRecordDT,visible:!0,popup:`<div id="mapPopup"><header><h5>${a.PlateNumber}</h5></header><main><ul><li><strong>Ultima actualizare</strong>: acum ${b} minute</li></ul></main></div>`};null!==app.dataSets.wasteCollection.markers[a.VehicleId].ref&&app.dataSets.wasteCollection.markers[a.VehicleId].ref.addListener("click",()=>{null!==app.map.popup&&(app.map.popup.close(),app.dataSets.wasteCollection.selectedMarker=null);app.dataSets.wasteCollection.selectedMarker=
app.dataSets.wasteCollection.markers[a.VehicleId].ref;app.map.popup=new google.maps.InfoWindow({content:app.dataSets.wasteCollection.markers[a.VehicleId].popup});app.map.popup.open(app.map.ref,app.dataSets.wasteCollection.selectedMarker)})}})}return{init:function(){google.maps.importLibrary("marker");e(12E4,()=>{c()})},getData:c,show:function(){f();e(3E4,()=>{c(()=>{f()})});app.dataSets.wasteCollection.visible=!0},hide:function(){e(12E4,()=>{c()});Object.values(app.dataSets.wasteCollection.markers).forEach(a=>
{a.ref&&a.ref.setMap(null)});app.dataSets.wasteCollection.markers=[];app.dataSets.wasteCollection.visible=!1}}})();(()=>{app.dataSets.wasteCollection.app=wasteCollection})();
