/*
 (c) 2023. Iasi Digital [https://iasi.digital]
*/
const wasteCollection=(()=>{function c(a=null){app.api("https://opendata.oras.digital/api/proxy/","POST",{action:"fetch",type:"api",value:"544f-2a7a-490a-ac5c-0f79"}).then(b=>b.ok?b.json():!1).then(b=>{app.dataSets.wasteCollection.data.vehicles=b;app.dataSets.wasteCollection.updated=Date.now();null!==a&&a()}).catch(b=>!1);return!0}function d(a,b=null){null!==app.dataSets.wasteCollection.watcher&&(clearInterval(app.dataSets.wasteCollection.watcher),app.dataSets.wasteCollection.watcher=null);app.dataSets.wasteCollection.watcher=
setInterval(()=>{null!==b&&b()},a)}function e(){void 0===app.dataSets.wasteCollection.data.vehicles?c(()=>{e()}):0<app.dataSets.wasteCollection.data.vehicles.length&&app.dataSets.wasteCollection.data.vehicles.forEach(a=>{let b=app.dateDiff(a.LastRecordDT);a.LastLatitude&&a.LastLongitude&&(app.dataSets.wasteCollection.markers[a.VehicleId]?(app.dataSets.wasteCollection.markers[a.VehicleId].ref.setCenter(new google.maps.LatLng(a.LastLatitude,a.LastLongitude)),app.dataSets.airQuality.markers[a.VehicleId].lastUpdate=
a.LastRecordDT,app.dataSets.airQuality.markers[a.id].popup=`<div id="mapPopup"><header><h5>${a.PlateNumber}</h5></header><main><ul><li><strong>Ultima actualizare</strong>: acum ${b} minute</li></ul></main></div>`):(app.dataSets.wasteCollection.markers[a.VehicleId]={id:a.VehicleId,ref:new google.maps.Marker({position:{lat:parseFloat(a.LastLatitude),lng:parseFloat(a.LastLongitude)},map:app.map.ref,title:a.PlateNumber,optimized:!0,icon:{url:`${app.cdn}pin/waste-collection/vehicle.png`,size:new google.maps.Size(28,
44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),lastUpdate:a.LastRecordDT,visible:!0,popup:`<div id="mapPopup"><header><h5>${a.PlateNumber}</h5></header><main><ul><li><strong>Ultima actualizare</strong>: acum ${b} minute</li></ul></main></div>`},null!==app.dataSets.wasteCollection.markers[a.VehicleId].ref&&app.dataSets.wasteCollection.markers[a.VehicleId].ref.addListener("click",()=>{null!==app.map.popup&&(app.map.popup.close(),app.dataSets.wasteCollection.selectedMarker=
null);app.dataSets.wasteCollection.selectedMarker=app.dataSets.wasteCollection.markers[a.VehicleId].ref;app.map.popup=new google.maps.InfoWindow({content:app.dataSets.wasteCollection.markers[a.VehicleId].popup});app.map.popup.open(app.map.ref,app.dataSets.wasteCollection.selectedMarker)})))})}return{init:function(){d(12E4,()=>{c()})},fetch:c,show:function(){e();d(2E4,()=>{c(()=>{e()})});app.dataSets.wasteCollection.visible=!0},hide:function(){d(6E4,()=>{c()});Object.values(app.dataSets.wasteCollection.markers).forEach(a=>
{a.ref&&a.ref.setMap(null)});app.dataSets.wasteCollection.markers=[];app.dataSets.wasteCollection.visible=!1}}})();(()=>{app.dataSets.wasteCollection.app=wasteCollection})();
