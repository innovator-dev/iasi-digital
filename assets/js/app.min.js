/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,m){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(m)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let m in this.items[k].callback)this.items[k].callback[m]()}}
const app=(()=>{function k(d,a,h){let g=document.getElementsByTagName("script")[0],e=document.createElement("script");void 0!==a&&null!==a&&(e.onreadystatechange=()=>{if("loaded"===e.readyState||"complete"===e.readyState)e.onreadystatechange=null,a(h)},e.onload=()=>{a(h)});e.setAttribute("src",d);e.setAttribute("defer","");g.parentNode.appendChild(e)}function m(d,a="error",h=0,g=!0){const e=document.querySelector(".notification-floating-placeholder");if(e){const l=e.querySelectorAll(".notification"),
b=document.createElement("p");b.classList.add("notification","notification-sm");b.classList.remove("error","success","info","warning");b.classList.add(a);b.innerHTML=d;g?(b.classList.add("notification-floating","notification-animation"),0<l.length&&(b.style.bottom=`${45*l.length+20}px`)):0<l.length&&(e.innerHTML="");e.appendChild(b);0<h&&setTimeout(()=>{b.classList.remove("notification","notification-sm","notification-inline","notification-animation","notification-floating","error","success","info",
"warning");b.innerHTML="";b.parentNode.removeChild(b)},1E3*h)}}function r(){p.add("renderMap",()=>{const d=document.querySelector("#map");d&&app.config.map&&k(app.config.map,()=>{c.ref=new google.maps.Map(d,{center:c.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",
stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},{visibility:"on"}]}]});
google.maps.event.addListenerOnce(c.ref,"tilesloaded",()=>{c.loaded=!0;p.fire("mapRenderControls")})})});p.fire("renderMap")}const p=new Observer,n={},c={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},f={app:null,watcher:null,visible:!1,updated:null,location:{lat:0,lng:0},persistent:!1};return{cdn:"https://iasi.digital/assets/",config:{},events:p,map:c,me:f,dataSets:n,dateDiff:function(d,a=!1){let h=d.split(/\D/);
d=new Date;a&&(d=new Date(d.getTime()+6E4*d.getTimezoneOffset()));a=new Date(h[0],h[1]-1,h[2],h[3],h[4],h[5]);if(isNaN(d)||isNaN(a))return null;a=Math.abs(d.getTime()-a.getTime());return Math.floor(a/1E3/60)},api:async function(d,a="GET",h="",g={}){h={method:a,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},g),body:h?JSON.stringify(h):""};"GET"!==a&&"HEAD"!==a||delete h.body;return await fetch(d,h)},fetch:function(d){try{return!d.url&&
app.config.messages["apiCall.error.missingUrl"]&&m(app.config.messages["apiCall.error.missingUrl"],"error",10),app.api(d.url,d.method||"GET",d.postFields||{}).then(a=>a.ok?a.json():!1).then(a=>{null!==d.callback&&d.callback(a)}).catch(a=>!1),!0}catch(a){m(a,"error",10)}},route:function(){const d=["route","method","query"];var a=window.location.pathname;const h=window.location.hash,g={};if(a&&(a=a.replace(/^\/?|\/?$/g,"").split("/"),0<a.length))for(let e=0;e<d.length;e++)g[d[e]]=a[e];h&&(g.hash=h.substring(1));
return g},notify:m,render:function(){p.add("initiateDirectionService",()=>{c.loaded&&(null===c.direction.service&&(c.direction.service=new google.maps.DirectionsService),null===c.direction.renderer&&(c.direction.renderer=new google.maps.DirectionsRenderer,c.direction.renderer.setMap(c.ref)),c.direction.loaded=!0)});p.add("clearDirectionService",()=>{null!==c.direction.service&&(c.direction.service=null);null!==c.direction.renderer&&(c.direction.renderer.setMap(null),c.direction.renderer=null);c.direction.loaded=
!1});p.add("mapRenderControls",()=>{const d=document.querySelector(".mapControls");if(d&&c.loaded){const h=document.createElement("div");h.classList.add("mapControlsContainer");var a=document.createElement("button");a.classList.add("mapCustomControl");a.innerHTML='<span data-icon="&#xe013;"></span>';a.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";a.type="button";a.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();0<c.mapCenter.lat&&0<c.mapCenter.lng&&(c.ref.panTo(new google.maps.LatLng(c.mapCenter.lat,
c.mapCenter.lng)),c.ref.setZoom(14))});h.appendChild(a);a=document.createElement("div");a.classList.add("mapControlsContainer");const g=document.createElement("button");g.setAttribute("data-state","disabled");g.classList.add("mapCustomControl","separator","hide");g.innerHTML='<span data-icon="&#xe015;"></span>';g.title="Activeaz\u0103/Dezactiveaz\u0103 localizarea persistent\u0103";g.type="button";g.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();"disabled"===g.getAttribute("data-state")?
(g.setAttribute("data-state","enabled"),g.classList.add("selected"),f.persistent=!0):(g.setAttribute("data-state","disabled"),g.classList.remove("selected"),f.persistent=!1)});const e=document.createElement("button");e.setAttribute("data-state","hideLocation");e.classList.add("mapCustomControl","separator");e.innerHTML='<span data-icon="&#xe016;"></span>';e.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea pe hart\u0103";e.type="button";e.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();
navigator.geolocation?"hideLocation"===e.getAttribute("data-state")?(e.setAttribute("data-state","showLocation"),e.classList.add("selected"),g.classList.remove("hide"),p.fire("initiateDirectionService"),f.watcher=navigator.geolocation.watchPosition(b=>{const q=b.coords.latitude;b=b.coords.longitude;f.location.lat=q;f.location.lng=b;null===f.app&&(f.app=new google.maps.Marker({position:{lat:parseFloat(q),lng:parseFloat(b)},map:app.map.ref,title:"Loca\u021bia mea",optimized:!0,icon:{url:"https://iasi.digital/assets/pin/me.png",
size:new google.maps.Size(22,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(11,35),scaledSize:new google.maps.Size(22,35)}}),f.app.setMap(c.ref));f.app.setPosition(new google.maps.LatLng(q,b));f.lastUpdate=(new Date).getTime();f.visible=!0;!0===f.persistent&&c.ref.panTo(new google.maps.LatLng(q,b))},()=>{try{null!==f.app&&(f.app.setMap(null),f.app=null),null!==f.watcher&&(navigator.geolocation.clearWatch(f.watcher),f.watcher=null),f.lastUpdate=null,f.visible=!1,f.location.lat=
0,f.location.lng=0,app.events.fire("clearDirectionService"),app.config.messages["location.error.unableToDetermine"]&&m(app.config.messages["location.error.unableToDetermine"],"error",10)}catch(b){m(b,"error",10),e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),e.setAttribute("disabled","disabled"),g.classList.remove("selected"),g.classList.add("hide"),g.setAttribute("data-state","disabled"),f.persistent=!1}},{enableHighAccuracy:!0,timeout:5E3})):(e.setAttribute("data-state",
"hideLocation"),e.classList.remove("selected"),g.classList.remove("selected"),g.classList.add("hide"),g.setAttribute("data-state","disabled"),f.persistent=!1,null!==f.app&&(f.app.setMap(null),f.app=null),null!==f.watcher&&(navigator.geolocation.clearWatch(f.watcher),f.watcher=null),f.lastUpdate=null,f.visible=!1,f.location.lat=0,f.location.lng=0,app.events.fire("clearDirectionService")):(e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),g.classList.add("hide"))});a.appendChild(g);
a.appendChild(e);c.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(h);c.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a);c.controls={spinner:d.querySelector("h2 .spinner"),publicTransportation:d.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:d.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:d.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:d.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),
wasteCollection:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};d.classList.remove("hide");d.querySelectorAll(".btn-toggle").forEach(l=>{const b=l.dataset;b.set&&(n[b.set]={app:null,watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},b.source&&(k(b.source,()=>{n[b.set].loaded=!0;n[b.set].app.getData()?(n[b.set].hasData=!0,n[b.set].app.init()):c.controls[b.set].setAttribute("disabled","disabled")}),l.addEventListener("click",
()=>{c.controls.spinner.classList.remove("hide");c.controls[b.set].checked?n[b.set].app.show():n[b.set].app.hide();c.controls.spinner.classList.add("hide")})),"trafficLayer"===b.set&&l.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[b.set].checked?(n[b.set].app=new google.maps.TrafficLayer,n[b.set].app.setMap(c.ref),n[b.set].visible=!0):(n[b.set].visible=!1,n[b.set].app.setMap(null),n[b.set].app=null);c.controls.spinner.classList.add("hide")}))})}});r()}}})();
(()=>{const k=document.querySelector("body.page").dataset;k.bind&&(app.config=JSON.parse(atob(k.bind)));app.api("config.json").then(m=>m.ok?m.json():!1).then(m=>{app.config=Object.assign(app.config,m)}).catch(m=>{});app.render()})();
