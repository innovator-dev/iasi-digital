/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,m){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(m)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let m in this.items[k].callback)this.items[k].callback[m]()}}
const app=(()=>{function k(d,a,h){let g=document.getElementsByTagName("script")[0],e=document.createElement("script");void 0!==a&&null!==a&&(e.onreadystatechange=()=>{if("loaded"===e.readyState||"complete"===e.readyState)e.onreadystatechange=null,a(h)},e.onload=()=>{a(h)});e.setAttribute("src",d);e.setAttribute("defer","");g.parentNode.appendChild(e)}function m(d,a="error",h=0,g=!0){const e=document.querySelector(".notification-floating-placeholder");if(e){const l=e.querySelectorAll(".notification"),
c=document.createElement("p");c.classList.add("notification","notification-sm");c.classList.remove("error","success","info","warning");c.classList.add(a);c.innerHTML=d;g?(c.classList.add("notification-floating","notification-animation"),0<l.length&&(c.style.bottom=`${45*l.length+20}px`)):0<l.length&&(e.innerHTML="");e.appendChild(c);0<h&&setTimeout(()=>{c.classList.remove("notification","notification-sm","notification-inline","notification-animation","notification-floating","error","success","info",
"warning");c.innerHTML="";c.parentNode.removeChild(c)},1E3*h)}}function t(){n.add("renderMap",()=>{const d=document.querySelector("#map");d&&app.config.map&&k(app.config.map,()=>{b.ref=new google.maps.Map(d,{center:b.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!0,mapId:"4c67bc89ba82ae84"});google.maps.event.addListenerOnce(b.ref,"tilesloaded",()=>{b.loaded=!0;n.fire("mapRenderControls")})})});n.fire("renderMap")}const n=new Observer,p={},b={ref:null,mapCenter:{lat:47.1553424,
lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},f={app:null,watcher:null,visible:!1,updated:null,location:{lat:0,lng:0},persistent:!1};return{cdn:"https://iasi.digital/assets/",config:{},events:n,map:b,me:f,dataSets:p,dateDiff:function(d,a=!1){let h=d.split(/\D/);d=new Date;a&&(d=new Date(d.getTime()+6E4*d.getTimezoneOffset()));a=new Date(h[0],h[1]-1,h[2],h[3],h[4],h[5]);if(isNaN(d)||isNaN(a))return null;a=Math.abs(d.getTime()-a.getTime());return Math.floor(a/
1E3/60)},api:async function(d,a="GET",h="",g={}){h={method:a,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},g),body:h?JSON.stringify(h):""};"GET"!==a&&"HEAD"!==a||delete h.body;return await fetch(d,h)},fetch:function(d){try{return!d.url&&app.config.messages["apiCall.error.missingUrl"]&&m(app.config.messages["apiCall.error.missingUrl"],"error",10),app.api(d.url,d.method||"GET",d.postFields||{}).then(a=>a.ok?
a.json():!1).then(a=>{null!==d.callback&&d.callback(a)}).catch(a=>!1),!0}catch(a){m(a,"error",10)}},route:function(){const d=["route","method","query"];var a=window.location.pathname;const h=window.location.hash,g={};if(a&&(a=a.replace(/^\/?|\/?$/g,"").split("/"),0<a.length))for(let e=0;e<d.length;e++)g[d[e]]=a[e];h&&(g.hash=h.substring(1));return g},notify:m,render:function(){google.maps.importLibrary("marker");n.add("initiateDirectionService",()=>{b.loaded&&(null===b.direction.service&&(b.direction.service=
new google.maps.DirectionsService),null===b.direction.renderer&&(b.direction.renderer=new google.maps.DirectionsRenderer,b.direction.renderer.setMap(b.ref)),b.direction.loaded=!0)});n.add("clearDirectionService",()=>{null!==b.direction.service&&(b.direction.service=null);null!==b.direction.renderer&&(b.direction.renderer.setMap(null),b.direction.renderer=null);b.direction.loaded=!1});n.add("showMyLocation",()=>{n.fire("initiateDirectionService")});n.add("hideMyLocation",()=>{n.fire("clearDirectionService")});
n.add("mapRenderControls",()=>{const d=document.querySelector(".mapControls");if(d&&b.loaded){const h=document.createElement("div");h.classList.add("mapControlsContainer");var a=document.createElement("button");a.classList.add("mapCustomControl");a.innerHTML='<span data-icon="&#xe013;"></span>';a.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";a.type="button";a.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();0<b.mapCenter.lat&&0<b.mapCenter.lng&&(b.ref.panTo(new google.maps.LatLng(b.mapCenter.lat,
b.mapCenter.lng)),b.ref.setZoom(14))});h.appendChild(a);a=document.createElement("div");a.classList.add("mapControlsContainer");const g=document.createElement("button");g.setAttribute("data-state","disabled");g.classList.add("mapCustomControl","separator","hide");g.innerHTML='<span data-icon="&#xe015;"></span>';g.title="Activeaz\u0103/Dezactiveaz\u0103 localizarea persistent\u0103";g.type="button";g.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();"disabled"===g.getAttribute("data-state")?
(g.setAttribute("data-state","enabled"),g.classList.add("selected"),f.persistent=!0):(g.setAttribute("data-state","disabled"),g.classList.remove("selected"),f.persistent=!1)});const e=document.createElement("button");e.setAttribute("data-state","hideLocation");e.classList.add("mapCustomControl","separator");e.innerHTML='<span data-icon="&#xe016;"></span>';e.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea pe hart\u0103";e.type="button";e.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();
if(navigator.geolocation)if("hideLocation"===e.getAttribute("data-state")){e.setAttribute("data-state","showLocation");e.classList.add("selected");g.classList.remove("hide");n.fire("showMyLocation");let c=document.createElement("img");c.src="https://iasi.digital/assets/pin/me.png";c.width=22;c.height=35;f.watcher=navigator.geolocation.watchPosition(q=>{const r=q.coords.latitude;q=q.coords.longitude;f.location.lat=r;f.location.lng=q;null===f.app&&(f.app=new google.maps.marker.AdvancedMarkerElement({position:{lat:parseFloat(r),
lng:parseFloat(q)},map:app.map.ref,title:"Loca\u021bia mea",content:c}),f.app.setMap(b.ref));f.app.position={lat:r,lng:q};f.lastUpdate=(new Date).getTime();f.visible=!0;!0===f.persistent&&b.ref.panTo(new google.maps.LatLng(r,q))},()=>{try{null!==f.app&&(f.app.setMap(null),f.app=null),null!==f.watcher&&(navigator.geolocation.clearWatch(f.watcher),f.watcher=null),f.lastUpdate=null,f.visible=!1,f.location.lat=0,f.location.lng=0,n.fire("hideMyLocation"),app.config.messages["location.error.unableToDetermine"]&&
m(app.config.messages["location.error.unableToDetermine"],"error",10)}catch(q){m(q,"error",10),e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),e.setAttribute("disabled","disabled"),g.classList.remove("selected"),g.classList.add("hide"),g.setAttribute("data-state","disabled"),f.persistent=!1}},{enableHighAccuracy:!0,timeout:5E3})}else e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),g.classList.remove("selected"),g.classList.add("hide"),g.setAttribute("data-state",
"disabled"),f.persistent=!1,null!==f.app&&(f.app.setMap(null),f.app=null),null!==f.watcher&&(navigator.geolocation.clearWatch(f.watcher),f.watcher=null),f.lastUpdate=null,f.visible=!1,f.location.lat=0,f.location.lng=0,n.fire("hideMyLocation");else e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),g.classList.add("hide")});a.appendChild(g);a.appendChild(e);b.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(h);b.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a);
b.controls={spinner:d.querySelector("h2 .spinner"),publicTransportation:d.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:d.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:d.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:d.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};
d.classList.remove("hide");d.querySelectorAll(".btn-toggle").forEach(l=>{const c=l.dataset;c.set&&(p[c.set]={app:null,watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},c.source&&(k(c.source,()=>{p[c.set].loaded=!0;p[c.set].app.getData()?(p[c.set].hasData=!0,p[c.set].app.init()):b.controls[c.set].setAttribute("disabled","disabled")}),l.addEventListener("click",()=>{b.controls.spinner.classList.remove("hide");b.controls[c.set].checked?p[c.set].app.show():
p[c.set].app.hide();b.controls.spinner.classList.add("hide")})),"trafficLayer"===c.set&&l.addEventListener("click",()=>{b.controls.spinner.classList.remove("hide");b.controls[c.set].checked?(p[c.set].app=new google.maps.TrafficLayer,p[c.set].app.setMap(b.ref),p[c.set].visible=!0):(p[c.set].visible=!1,p[c.set].app.setMap(null),p[c.set].app=null);b.controls.spinner.classList.add("hide")}))})}});t()}}})();
(()=>{const k=document.querySelector("body.page").dataset;k.bind&&(app.config=JSON.parse(atob(k.bind)));app.api("config.json").then(m=>m.ok?m.json():!1).then(m=>{app.config=Object.assign(app.config,m)}).catch(m=>{});app.render()})();
