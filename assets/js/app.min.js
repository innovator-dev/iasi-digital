/*
 (c) 2023. Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(g,k){this.items[g]||(this.items[g]={name:g,callback:[]});this.items[g].callback.push(k)}fireAll(){for(let g in this.items)this.fire(g)}clearAll(g){this.items[g]={name:g,callback:[]}}fire(g){if(this.items[g])for(let k in this.items[g].callback)this.items[g].callback[k]()}}
const app=(()=>{function g(d,c,a){let h=document.getElementsByTagName("script")[0],f=document.createElement("script");void 0!==c&&null!==c&&(f.onreadystatechange=()=>{if("loaded"===f.readyState||"complete"===f.readyState)f.onreadystatechange=null,c(a)},f.onload=()=>{c(a)});f.setAttribute("src",d);f.setAttribute("defer","");h.parentNode.appendChild(f)}const k=new Observer,b={},e={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{}};return{cdn:"https://iasi.digital/assets/",
events:k,map:e,dataSets:b,dateDiff:function(d,c=!1){let a=d.split(/\D/);d=new Date;c&&(d=new Date(d.getTime()+6E4*d.getTimezoneOffset()));c=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5]);if(isNaN(d)||isNaN(c))return null;c=Math.abs(d.getTime()-c.getTime());return Math.floor(c/1E3/60)},api:async function(d,c="GET",a="",h={}){a={method:c,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},h),body:a?JSON.stringify(a):""};
"GET"!==c&&"HEAD"!==c||delete a.body;return await fetch(d,a)},route:function(){const d=["route","method","query"];var c=window.location.pathname;const a=window.location.hash,h={};if(c&&(c=c.replace(/^\/?|\/?$/g,"").split("/"),0<c.length))for(let f=0;f<d.length;f++)h[d[f]]=c[f];a&&(h.hash=a.substring(1));return h},render:function(){k.add("mapRenderControls",()=>{const d=document.querySelector(".mapControls");d&&e.loaded&&(e.controls={spinner:d.querySelector("h3 .spinner"),myLocation:d.querySelector('input[type=checkbox][name="toggle.myLocation"]'),
publicTransportation:d.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:d.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:d.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:d.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]'),wasteCollectionPoints:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollectionPoints"]')},
d.classList.remove("hide"),d.querySelectorAll(".btn-toggle").forEach(c=>{const a=c.dataset;a.set&&(b[a.set]={app:null,watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},a.source?(g(a.source,()=>{b[a.set].loaded=!0;b[a.set].app.fetch()?(b[a.set].hasData=!0,b[a.set].app.init()):e.controls[a.set].setAttribute("disabled","disabled")}),c.addEventListener("click",()=>{e.controls.spinner.classList.remove("hide");e.controls[a.set].checked?b[a.set].app.show():
b[a.set].app.hide();e.controls.spinner.classList.add("hide")})):"trafficLayer"===a.set?c.addEventListener("click",()=>{e.controls.spinner.classList.remove("hide");e.controls[a.set].checked?(b[a.set].app=new google.maps.TrafficLayer,b[a.set].app.setMap(e.ref),b[a.set].visible=!0):(b[a.set].visible=!1,b[a.set].app.setMap(null),b[a.set].app=null);e.controls.spinner.classList.add("hide")}):"myLocation"===a.set&&(navigator.geolocation?c.addEventListener("click",()=>{e.controls.spinner.classList.remove("hide");
e.controls[a.set].checked?b[a.set].watcher=navigator.geolocation.watchPosition(h=>{const f=h.coords.latitude;h=h.coords.longitude;null===b[a.set].app&&(b[a.set].app=new google.maps.Marker({position:{lat:parseFloat(f),lng:parseFloat(h)},map:app.map.ref,title:"Loca\u021bia mea",icon:{url:"https://iasi.digital/assets/pin/me.png",size:new google.maps.Size(28,44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),b[a.set].app.setMap(e.ref));b[a.set].app.setPosition(new google.maps.LatLng(f,
h));b[a.set].lastUpdate=(new Date).getTime();b[a.set].visible=!0;e.ref.panTo(new google.maps.LatLng(f,h));e.ref.setZoom(16)},()=>{e.controls[a.set].checked=!1;null!==b[a.set].app&&(b[a.set].app.setMap(null),b[a.set].app=null);null!==b[a.set].watcher&&(navigator.geolocation.clearWatch(b[a.set].watcher),b[a.set].watcher=null);b[a.set].lastUpdate=null;b[a.set].visible=!1;e.ref.setZoom(14);e.ref.panTo(new google.maps.LatLng(app.map.mapCenter))},{enableHighAccuracy:!0,timeout:5E3}):(null!==b[a.set].app&&
(b[a.set].app.setMap(null),b[a.set].app=null),null!==b[a.set].watcher&&(navigator.geolocation.clearWatch(b[a.set].watcher),b[a.set].watcher=null),b[a.set].lastUpdate=null,b[a.set].visible=!1,e.ref.setZoom(14),e.ref.panTo(new google.maps.LatLng(app.map.mapCenter)));e.controls.spinner.classList.add("hide")}):e.controls[a.set].setAttribute("disabled","disabled")))}))});k.add("renderMap",()=>{const d=document.querySelector("#map");if(d){var c=d.dataset;c.bind&&(c=JSON.parse(atob(c.bind)),g(c.url,()=>
{e.ref=new google.maps.Map(d,{center:e.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},
{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},{visibility:"on"}]}]});google.maps.event.addListenerOnce(e.ref,"tilesloaded",()=>{e.loaded=!0;k.fire("mapRenderControls")})}))}});k.fire("renderMap")}}})();(()=>{app.render()})();
