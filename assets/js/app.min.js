/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,m){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(m)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let m in this.items[k].callback)this.items[k].callback[m]()}}
const app=(()=>{function k(c,a,h){let f=document.getElementsByTagName("script")[0],g=document.createElement("script");void 0!==a&&null!==a&&(g.onreadystatechange=()=>{if("loaded"===g.readyState||"complete"===g.readyState)g.onreadystatechange=null,a(h)},g.onload=()=>{a(h)});g.setAttribute("src",c);g.setAttribute("defer","");f.parentNode.appendChild(g)}const m=new Observer,l={},b={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},myLocation:{lat:0,lng:0},loaded:!1,popup:null,controls:{}},e={app:null,
watcher:null,visible:!1,updated:null};return{cdn:"https://iasi.digital/assets/",events:m,map:b,me:e,dataSets:l,dateDiff:function(c,a=!1){let h=c.split(/\D/);c=new Date;a&&(c=new Date(c.getTime()+6E4*c.getTimezoneOffset()));a=new Date(h[0],h[1]-1,h[2],h[3],h[4],h[5]);if(isNaN(c)||isNaN(a))return null;a=Math.abs(c.getTime()-a.getTime());return Math.floor(a/1E3/60)},api:async function(c,a="GET",h="",f={}){h={method:a,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json",
"Content-Type":"application/json"},f),body:h?JSON.stringify(h):""};"GET"!==a&&"HEAD"!==a||delete h.body;return await fetch(c,h)},route:function(){const c=["route","method","query"];var a=window.location.pathname;const h=window.location.hash,f={};if(a&&(a=a.replace(/^\/?|\/?$/g,"").split("/"),0<a.length))for(let g=0;g<c.length;g++)f[c[g]]=a[g];h&&(f.hash=h.substring(1));return f},render:function(){m.add("mapRenderControls",()=>{const c=document.querySelector(".mapControls");if(c&&b.loaded){const h=
document.createElement("div");var a=document.createElement("button");a.classList.add("mapCustomControl");a.innerHTML='<span data-icon="&#xe013;"></span>';a.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";a.type="button";a.addEventListener("click",g=>{g.preventDefault();g.stopPropagation();0<b.mapCenter.lat&&0<b.mapCenter.lng&&b.ref.panTo(new google.maps.LatLng(b.mapCenter.lat,b.mapCenter.lng))});h.appendChild(a);a=document.createElement("div");const f=document.createElement("button");f.setAttribute("data-state",
"hideLocation");f.classList.add("mapCustomControl","separator");f.innerHTML='<span data-icon="&#xe015;"></span>';f.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea";f.type="button";f.addEventListener("click",g=>{g.preventDefault();g.stopPropagation();navigator.geolocation?"hideLocation"===f.getAttribute("data-state")?(f.setAttribute("data-state","showLocation"),f.classList.add("selected"),e.watcher=navigator.geolocation.watchPosition(d=>{const n=d.coords.latitude;d=d.coords.longitude;b.myLocation.lat=
n;b.myLocation.lng=d;null===e.app&&(e.app=new google.maps.Marker({position:{lat:parseFloat(n),lng:parseFloat(d)},map:app.map.ref,title:"Loca\u021bia mea",icon:{url:"https://iasi.digital/assets/pin/me.png",size:new google.maps.Size(28,44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),e.app.setMap(b.ref));e.app.setPosition(new google.maps.LatLng(n,d));e.lastUpdate=(new Date).getTime();e.visible=!0;b.ref.panTo(new google.maps.LatLng(n,
d))},()=>{null!==e.app&&(e.app.setMap(null),e.app=null);null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null);e.lastUpdate=null;e.visible=!1;b.myLocation.lat=0;b.myLocation.lng=0},{enableHighAccuracy:!0,timeout:5E3})):(f.setAttribute("data-state","hideLocation"),f.classList.remove("selected"),null!==e.app&&(e.app.setMap(null),e.app=null),null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null),e.lastUpdate=null,e.visible=!1,b.myLocation.lat=0,b.myLocation.lng=
0):(f.setAttribute("data-state","hideLocation"),f.classList.remove("selected"),f.setAttribute("disabled","disabled"))});a.appendChild(f);b.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(h);b.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a);b.controls={spinner:c.querySelector("h3 .spinner"),publicTransportation:c.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:c.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),
trafficLayer:c.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:c.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:c.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]'),wasteCollectionPoints:c.querySelector('input[type=checkbox][name="toggle.environment.wasteCollectionPoints"]')};c.classList.remove("hide");c.querySelectorAll(".btn-toggle").forEach(g=>{const d=g.dataset;d.set&&(l[d.set]={app:null,
watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},d.source&&(k(d.source,()=>{l[d.set].loaded=!0;l[d.set].app.fetch()?(l[d.set].hasData=!0,l[d.set].app.init()):b.controls[d.set].setAttribute("disabled","disabled")}),g.addEventListener("click",()=>{b.controls.spinner.classList.remove("hide");b.controls[d.set].checked?l[d.set].app.show():l[d.set].app.hide();b.controls.spinner.classList.add("hide")})),"trafficLayer"===d.set&&g.addEventListener("click",()=>
{b.controls.spinner.classList.remove("hide");b.controls[d.set].checked?(l[d.set].app=new google.maps.TrafficLayer,l[d.set].app.setMap(b.ref),l[d.set].visible=!0):(l[d.set].visible=!1,l[d.set].app.setMap(null),l[d.set].app=null);b.controls.spinner.classList.add("hide")}))})}});m.add("renderMap",()=>{const c=document.querySelector("#map");if(c){var a=c.dataset;a.bind&&(a=JSON.parse(atob(a.bind)),k(a.url,()=>{b.ref=new google.maps.Map(c,{center:b.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,
fullscreenControl:!1,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},
{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},{visibility:"on"}]}]});google.maps.event.addListenerOnce(b.ref,"tilesloaded",()=>{b.loaded=!0;m.fire("mapRenderControls")})}))}});m.fire("renderMap")}}})();(()=>{app.render()})();
