/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,m){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(m)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let m in this.items[k].callback)this.items[k].callback[m]()}}
const app=(()=>{function k(d,a,g){let f=document.getElementsByTagName("script")[0],e=document.createElement("script");void 0!==a&&null!==a&&(e.onreadystatechange=()=>{if("loaded"===e.readyState||"complete"===e.readyState)e.onreadystatechange=null,a(g)},e.onload=()=>{a(g)});e.setAttribute("src",d);e.setAttribute("defer","");f.parentNode.appendChild(e)}function m(d,a="error",g=0,f=!0){const e=document.querySelector(".notification-floating-placeholder");if(e){const l=e.querySelectorAll(".notification"),
b=document.createElement("p");b.classList.add("notification","notification-sm");b.classList.remove("error","success","info","warning");b.classList.add(a);b.innerHTML=d;f?(b.classList.add("notification-floating","notification-animation"),0<l.length&&(b.style.bottom=`${45*l.length+20}px`)):0<l.length&&(e.innerHTML="");e.appendChild(b);0<g&&setTimeout(()=>{b.classList.remove("notification","notification-sm","notification-inline","notification-animation","notification-floating","error","success","info",
"warning");b.innerHTML="";b.parentNode.removeChild(b)},1E3*g)}}function r(){n.add("renderMap",()=>{const d=document.querySelector("#map");d&&app.config.map&&k(app.config.map,()=>{c.ref=new google.maps.Map(d,{center:c.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!0,mapId:"4c67bc89ba82ae84"});google.maps.event.addListenerOnce(c.ref,"tilesloaded",()=>{c.loaded=!0;n.fire("mapRenderControls");google.maps.importLibrary("marker")})})});n.fire("renderMap")}const n=new Observer,
p={},c={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},h={app:null,watcher:null,visible:!1,updated:null,location:{lat:0,lng:0},persistent:!1};return{cdn:"https://iasi.digital/assets/",config:{},events:n,map:c,me:h,dataSets:p,dateDiff:function(d,a=!1){let g=d.split(/\D/);d=new Date;a&&(d=new Date(d.getTime()+6E4*d.getTimezoneOffset()));a=new Date(g[0],g[1]-1,g[2],g[3],g[4],g[5]);if(isNaN(d)||isNaN(a))return null;
a=Math.abs(d.getTime()-a.getTime());return Math.floor(a/1E3/60)},api:async function(d,a="GET",g="",f={}){g={method:a,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},f),body:g?JSON.stringify(g):""};"GET"!==a&&"HEAD"!==a||delete g.body;return await fetch(d,g)},inc:k,fetch:function(d){try{return!d.url&&app.config.messages["apiCall.error.missingUrl"]&&m(app.config.messages["apiCall.error.missingUrl"],"error",10),
app.api(d.url,d.method||"GET",d.postFields||{}).then(a=>a.ok?a.json():!1).then(a=>{null!==d.callback&&d.callback(a)}).catch(a=>!1),!0}catch(a){m(a,"error",10)}},route:function(){const d=["route","method","query"];var a=window.location.pathname;const g=window.location.hash,f={};if(a&&(a=a.replace(/^\/?|\/?$/g,"").split("/"),0<a.length))for(let e=0;e<d.length;e++)f[d[e]]=a[e];g&&(f.hash=g.substring(1));return f},notify:m,render:function(){n.add("initiateDirectionService",()=>{c.loaded&&(null===c.direction.service&&
(c.direction.service=new google.maps.DirectionsService),null===c.direction.renderer&&(c.direction.renderer=new google.maps.DirectionsRenderer,c.direction.renderer.setMap(c.ref)),c.direction.loaded=!0)});n.add("clearDirectionService",()=>{null!==c.direction.service&&(c.direction.service=null);null!==c.direction.renderer&&(c.direction.renderer.setMap(null),c.direction.renderer=null);c.direction.loaded=!1});n.add("showMyLocation",()=>{n.fire("initiateDirectionService")});n.add("hideMyLocation",()=>{n.fire("clearDirectionService");
null!==h.app&&(h.app.setMap(null),h.app=null);null!==h.watcher&&(navigator.geolocation.clearWatch(h.watcher),h.watcher=null);h.updated=null;h.visible=!1;h.location.lat=0;h.location.lng=0});n.add("mapRenderControls",()=>{const d=document.querySelector(".mapControls");if(d&&c.loaded){const g=document.createElement("div");g.classList.add("mapControlsContainer");var a=document.createElement("button");a.classList.add("mapCustomControl");a.innerHTML='<span data-icon="&#xe013;"></span>';a.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";
a.type="button";a.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();0<c.mapCenter.lat&&0<c.mapCenter.lng&&(c.ref.panTo(new google.maps.LatLng(c.mapCenter.lat,c.mapCenter.lng)),c.ref.setZoom(14))});g.appendChild(a);a=document.createElement("div");a.classList.add("mapControlsContainer");const f=document.createElement("button");f.setAttribute("data-state","disabled");f.classList.add("mapCustomControl","separator","hide");f.innerHTML='<span data-icon="&#xe015;"></span>';f.title="Activeaz\u0103/Dezactiveaz\u0103 localizarea persistent\u0103";
f.type="button";f.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();"disabled"===f.getAttribute("data-state")?(f.setAttribute("data-state","enabled"),f.classList.add("selected"),h.persistent=!0):(f.setAttribute("data-state","disabled"),f.classList.remove("selected"),h.persistent=!1)});const e=document.createElement("button");e.setAttribute("data-state","hideLocation");e.classList.add("mapCustomControl","separator");e.innerHTML='<span data-icon="&#xe016;"></span>';e.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea pe hart\u0103";
e.type="button";e.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();navigator.geolocation?"hideLocation"===e.getAttribute("data-state")?(e.setAttribute("data-state","showLocation"),e.classList.add("selected"),f.classList.remove("hide"),n.fire("showMyLocation"),h.watcher=navigator.geolocation.watchPosition(b=>{const q=b.coords.latitude;b=b.coords.longitude;h.location.lat=q;h.location.lng=b;const t=new google.maps.marker.PinElement({glyphColor:"#fff",background:"#31496d",borderColor:"#31496d"});
null===h.app&&(h.app=new google.maps.marker.AdvancedMarkerElement({position:{lat:parseFloat(q),lng:parseFloat(b)},map:app.map.ref,title:"Loca\u021bia mea",content:t.element}),h.app.setMap(c.ref));h.app.position={lat:q,lng:b};h.updated=(new Date).getTime();h.visible=!0;!0===h.persistent&&c.ref.panTo(new google.maps.LatLng(q,b))},()=>{try{n.fire("hideMyLocation"),app.config.messages["location.error.unableToDetermine"]&&m(app.config.messages["location.error.unableToDetermine"],"info",10)}catch(b){m(b,
"error",10),e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),e.setAttribute("disabled","disabled"),f.classList.remove("selected"),f.classList.add("hide"),f.setAttribute("data-state","disabled"),h.persistent=!1}},{enableHighAccuracy:!0,timeout:5E3})):(e.setAttribute("data-state","hideLocation"),e.classList.remove("selected"),f.classList.remove("selected"),f.classList.add("hide"),f.setAttribute("data-state","disabled"),h.persistent=!1,n.fire("hideMyLocation")):(e.setAttribute("data-state",
"hideLocation"),e.classList.remove("selected"),f.classList.add("hide"))});a.appendChild(f);a.appendChild(e);c.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(g);c.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a);c.controls={spinner:d.querySelector("h2 .spinner"),publicTransportation:d.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:d.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:d.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),
airQuality:d.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};d.classList.remove("hide");d.querySelectorAll(".btn-toggle").forEach(l=>{const b=l.dataset;b.set&&(p[b.set]={app:null,watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null,args:{}},b.source&&(k(b.source,()=>{p[b.set].loaded=!0;p[b.set].app.getData()?(p[b.set].hasData=!0,
p[b.set].app.init()):c.controls[b.set].setAttribute("disabled","disabled")}),l.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[b.set].checked?p[b.set].app.show():p[b.set].app.hide();c.controls.spinner.classList.add("hide")})),"trafficLayer"===b.set&&l.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[b.set].checked?(p[b.set].app=new google.maps.TrafficLayer,p[b.set].app.setMap(c.ref),p[b.set].visible=!0):(p[b.set].visible=!1,
p[b.set].app.setMap(null),p[b.set].app=null);c.controls.spinner.classList.add("hide")}))})}});r()}}})();(()=>{const k=document.querySelector("body.page").dataset;k.bind&&(app.config=JSON.parse(atob(k.bind)));app.api("config.json").then(m=>m.ok?m.json():!1).then(m=>{app.config=Object.assign(app.config,m)}).catch(m=>{});app.render()})();
