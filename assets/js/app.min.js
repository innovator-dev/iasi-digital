/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,p){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(p)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let p in this.items[k].callback)this.items[k].callback[p]()}}
const app=(()=>{function k(d,b,h){let f=document.getElementsByTagName("script")[0],g=document.createElement("script");void 0!==b&&null!==b&&(g.onreadystatechange=()=>{if("loaded"===g.readyState||"complete"===g.readyState)g.onreadystatechange=null,b(h)},g.onload=()=>{b(h)});g.setAttribute("src",d);g.setAttribute("defer","");f.parentNode.appendChild(g)}function p(d,b="error",h=0,f=!0){const g=document.querySelector(".notification-floating-placeholder");if(g){const c=g.querySelectorAll(".notification"),
l=document.createElement("p");l.classList.add("notification","notification-sm");l.classList.remove("error","success","info","warning");l.classList.add(b);l.innerHTML=d;f?(l.classList.add("notification-floating","notification-animation"),0<c.length&&(l.style.bottom=`${45*c.length+20}px`)):0<c.length&&(g.innerHTML="");g.appendChild(l);0<h&&setTimeout(()=>{l.classList.remove("notification","notification-sm","notification-inline","notification-animation","notification-floating","error","success","info",
"warning");l.innerHTML="";l.parentNode.removeChild(l)},1E3*h)}}const n=new Observer,m={},a={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},e={app:null,watcher:null,visible:!1,updated:null,location:{lat:0,lng:0}};return{cdn:"https://iasi.digital/assets/",events:n,map:a,me:e,dataSets:m,dateDiff:function(d,b=!1){let h=d.split(/\D/);d=new Date;b&&(d=new Date(d.getTime()+6E4*d.getTimezoneOffset()));b=new Date(h[0],h[1]-
1,h[2],h[3],h[4],h[5]);if(isNaN(d)||isNaN(b))return null;b=Math.abs(d.getTime()-b.getTime());return Math.floor(b/1E3/60)},api:async function(d,b="GET",h="",f={}){h={method:b,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},f),body:h?JSON.stringify(h):""};"GET"!==b&&"HEAD"!==b||delete h.body;return await fetch(d,h)},route:function(){const d=["route","method","query"];var b=window.location.pathname;const h=window.location.hash,
f={};if(b&&(b=b.replace(/^\/?|\/?$/g,"").split("/"),0<b.length))for(let g=0;g<d.length;g++)f[d[g]]=b[g];h&&(f.hash=h.substring(1));return f},notify:p,render:function(){n.add("initiateDirectionService",()=>{a.loaded&&(null===a.direction.service&&(a.direction.service=new google.maps.DirectionsService),null===a.direction.renderer&&(a.direction.renderer=new google.maps.DirectionsRenderer,a.direction.renderer.setMap(a.ref)),a.direction.loaded=!0)});n.add("clearDirectionService",()=>{null!==a.direction.service&&
(a.direction.service=null);null!==a.direction.renderer&&(a.direction.renderer.setMap(null),a.direction.renderer=null);a.direction.loaded=!1});n.add("mapRenderControls",()=>{const d=document.querySelector(".mapControls");if(d&&a.loaded){const h=document.createElement("div");var b=document.createElement("button");b.classList.add("mapCustomControl");b.innerHTML='<span data-icon="&#xe013;"></span>';b.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";b.type="button";b.addEventListener("click",g=>{g.preventDefault();
g.stopPropagation();0<a.mapCenter.lat&&0<a.mapCenter.lng&&(a.ref.panTo(new google.maps.LatLng(a.mapCenter.lat,a.mapCenter.lng)),a.ref.setZoom(14))});h.appendChild(b);b=document.createElement("div");const f=document.createElement("button");f.setAttribute("data-state","hideLocation");f.classList.add("mapCustomControl","separator");f.innerHTML='<span data-icon="&#xe015;"></span>';f.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea";f.type="button";f.addEventListener("click",g=>{g.preventDefault();g.stopPropagation();
navigator.geolocation?"hideLocation"===f.getAttribute("data-state")?(f.setAttribute("data-state","showLocation"),f.classList.add("selected"),n.fire("initiateDirectionService"),e.watcher=navigator.geolocation.watchPosition(c=>{const l=c.coords.latitude;c=c.coords.longitude;e.location.lat=l;e.location.lng=c;null===e.app&&(e.app=new google.maps.Marker({position:{lat:parseFloat(l),lng:parseFloat(c)},map:app.map.ref,title:"Loca\u021bia mea",icon:{url:"https://iasi.digital/assets/pin/me.png",size:new google.maps.Size(28,
44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),e.app.setMap(a.ref));e.app.setPosition(new google.maps.LatLng(l,c));e.lastUpdate=(new Date).getTime();e.visible=!0;a.ref.panTo(new google.maps.LatLng(l,c))},()=>{try{throw null!==e.app&&(e.app.setMap(null),e.app=null),null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null),e.lastUpdate=null,e.visible=!1,e.location.lat=0,e.location.lng=0,app.events.fire("clearDirectionService"),
"Nu a putut fi determinat\u0103 pozi\u021bia. Verifica\u021bi dac\u0103 browser-ul are permisiunea de a prelua loca\u021bia.";}catch(c){p(c,"error",10),f.setAttribute("data-state","hideLocation"),f.classList.remove("selected"),f.setAttribute("disabled","disabled")}},{enableHighAccuracy:!0,timeout:5E3})):(f.setAttribute("data-state","hideLocation"),f.classList.remove("selected"),null!==e.app&&(e.app.setMap(null),e.app=null),null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null),
e.lastUpdate=null,e.visible=!1,e.location.lat=0,e.location.lng=0,app.events.fire("clearDirectionService")):(f.setAttribute("data-state","hideLocation"),f.classList.remove("selected"),f.setAttribute("disabled","disabled"))});b.appendChild(f);a.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(h);a.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(b);a.controls={spinner:d.querySelector("h3 .spinner"),publicTransportation:d.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),
publicParking:d.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:d.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:d.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};d.classList.remove("hide");d.querySelectorAll(".btn-toggle").forEach(g=>{const c=g.dataset;c.set&&(m[c.set]={app:null,watcher:null,
loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},c.source&&(k(c.source,()=>{m[c.set].loaded=!0;m[c.set].app.fetch()?(m[c.set].hasData=!0,m[c.set].app.init()):a.controls[c.set].setAttribute("disabled","disabled")}),g.addEventListener("click",()=>{a.controls.spinner.classList.remove("hide");a.controls[c.set].checked?m[c.set].app.show():m[c.set].app.hide();a.controls.spinner.classList.add("hide")})),"trafficLayer"===c.set&&g.addEventListener("click",()=>{a.controls.spinner.classList.remove("hide");
a.controls[c.set].checked?(m[c.set].app=new google.maps.TrafficLayer,m[c.set].app.setMap(a.ref),m[c.set].visible=!0):(m[c.set].visible=!1,m[c.set].app.setMap(null),m[c.set].app=null);a.controls.spinner.classList.add("hide")}))})}});n.add("renderMap",()=>{const d=document.querySelector("#map");if(d){var b=d.dataset;b.bind&&(b=JSON.parse(atob(b.bind)),k(b.url,()=>{a.ref=new google.maps.Map(d,{center:a.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,styles:[{featureType:"administrative",
elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",
stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},{visibility:"on"}]}]});google.maps.event.addListenerOnce(a.ref,"tilesloaded",()=>{a.loaded=!0;n.fire("mapRenderControls")})}))}});n.fire("renderMap")}}})();(()=>{app.render()})();
