/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,p){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(p)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let p in this.items[k].callback)this.items[k].callback[p]()}}
const app=(()=>{function k(f,b,h){let g=document.getElementsByTagName("script")[0],d=document.createElement("script");void 0!==b&&null!==b&&(d.onreadystatechange=()=>{if("loaded"===d.readyState||"complete"===d.readyState)d.onreadystatechange=null,b(h)},d.onload=()=>{b(h)});d.setAttribute("src",f);d.setAttribute("defer","");g.parentNode.appendChild(d)}function p(f,b="error",h=0,g=!0){const d=document.querySelector(".notification-floating-placeholder");if(d){const l=d.querySelectorAll(".notification"),
a=document.createElement("p");a.classList.add("notification","notification-sm");a.classList.remove("error","success","info","warning");a.classList.add(b);a.innerHTML=f;g?(a.classList.add("notification-floating","notification-animation"),0<l.length&&(a.style.bottom=`${45*l.length+20}px`)):0<l.length&&(d.innerHTML="");d.appendChild(a);0<h&&setTimeout(()=>{a.classList.remove("notification","notification-sm","notification-inline","notification-animation","notification-floating","error","success","info",
"warning");a.innerHTML="";a.parentNode.removeChild(a)},1E3*h)}}const n=new Observer,m={},c={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},e={app:null,watcher:null,visible:!1,updated:null,location:{lat:0,lng:0},persistent:!1};return{cdn:"https://iasi.digital/assets/",events:n,map:c,me:e,dataSets:m,dateDiff:function(f,b=!1){let h=f.split(/\D/);f=new Date;b&&(f=new Date(f.getTime()+6E4*f.getTimezoneOffset()));b=new Date(h[0],
h[1]-1,h[2],h[3],h[4],h[5]);if(isNaN(f)||isNaN(b))return null;b=Math.abs(f.getTime()-b.getTime());return Math.floor(b/1E3/60)},api:async function(f,b="GET",h="",g={}){h={method:b,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},g),body:h?JSON.stringify(h):""};"GET"!==b&&"HEAD"!==b||delete h.body;return await fetch(f,h)},route:function(){const f=["route","method","query"];var b=window.location.pathname;const h=
window.location.hash,g={};if(b&&(b=b.replace(/^\/?|\/?$/g,"").split("/"),0<b.length))for(let d=0;d<f.length;d++)g[f[d]]=b[d];h&&(g.hash=h.substring(1));return g},notify:p,render:function(){n.add("initiateDirectionService",()=>{c.loaded&&(null===c.direction.service&&(c.direction.service=new google.maps.DirectionsService),null===c.direction.renderer&&(c.direction.renderer=new google.maps.DirectionsRenderer,c.direction.renderer.setMap(c.ref)),c.direction.loaded=!0)});n.add("clearDirectionService",()=>
{null!==c.direction.service&&(c.direction.service=null);null!==c.direction.renderer&&(c.direction.renderer.setMap(null),c.direction.renderer=null);c.direction.loaded=!1});n.add("mapRenderControls",()=>{const f=document.querySelector(".mapControls");if(f&&c.loaded){const h=document.createElement("div");h.classList.add("mapControlsContainer");var b=document.createElement("button");b.classList.add("mapCustomControl");b.innerHTML='<span data-icon="&#xe013;"></span>';b.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";
b.type="button";b.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();0<c.mapCenter.lat&&0<c.mapCenter.lng&&(c.ref.panTo(new google.maps.LatLng(c.mapCenter.lat,c.mapCenter.lng)),c.ref.setZoom(14))});h.appendChild(b);b=document.createElement("div");b.classList.add("mapControlsContainer");const g=document.createElement("button");g.setAttribute("data-state","disabled");g.classList.add("mapCustomControl","separator","hide");g.innerHTML='<span data-icon="&#xe015;"></span>';g.title="Activeaz\u0103/Dezactiveaz\u0103 localizarea persistent\u0103";
g.type="button";g.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();"disabled"===g.getAttribute("data-state")?(g.setAttribute("data-state","enabled"),g.classList.add("selected"),e.persistent=!0):(g.setAttribute("data-state","disabled"),g.classList.remove("selected"),e.persistent=!1)});const d=document.createElement("button");d.setAttribute("data-state","hideLocation");d.classList.add("mapCustomControl","separator");d.innerHTML='<span data-icon="&#xe016;"></span>';d.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea pe hart\u0103";
d.type="button";d.addEventListener("click",l=>{l.preventDefault();l.stopPropagation();navigator.geolocation?"hideLocation"===d.getAttribute("data-state")?(d.setAttribute("data-state","showLocation"),d.classList.add("selected"),g.classList.remove("hide"),n.fire("initiateDirectionService"),e.watcher=navigator.geolocation.watchPosition(a=>{const q=a.coords.latitude;a=a.coords.longitude;e.location.lat=q;e.location.lng=a;null===e.app&&(e.app=new google.maps.Marker({position:{lat:parseFloat(q),lng:parseFloat(a)},
map:app.map.ref,title:"Loca\u021bia mea",icon:{url:"https://iasi.digital/assets/pin/me.png",size:new google.maps.Size(28,44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),e.app.setMap(c.ref));e.app.setPosition(new google.maps.LatLng(q,a));e.lastUpdate=(new Date).getTime();e.visible=!0;!0===e.persistent&&c.ref.panTo(new google.maps.LatLng(q,a))},()=>{try{throw null!==e.app&&(e.app.setMap(null),e.app=null),null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),
e.watcher=null),e.lastUpdate=null,e.visible=!1,e.location.lat=0,e.location.lng=0,app.events.fire("clearDirectionService"),"Nu a putut fi determinat\u0103 pozi\u021bia. Verifica\u021bi dac\u0103 browser-ul are permisiunea de a prelua loca\u021bia.";}catch(a){p(a,"error",10),d.setAttribute("data-state","hideLocation"),d.classList.remove("selected"),d.setAttribute("disabled","disabled"),g.classList.remove("selected"),g.classList.add("hide"),g.setAttribute("data-state","disabled"),e.persistent=!1}},{enableHighAccuracy:!0,
timeout:5E3})):(d.setAttribute("data-state","hideLocation"),d.classList.remove("selected"),g.classList.remove("selected"),g.classList.add("hide"),g.setAttribute("data-state","disabled"),e.persistent=!1,null!==e.app&&(e.app.setMap(null),e.app=null),null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null),e.lastUpdate=null,e.visible=!1,e.location.lat=0,e.location.lng=0,app.events.fire("clearDirectionService")):(d.setAttribute("data-state","hideLocation"),d.classList.remove("selected"),
d.setAttribute("disabled","disabled"),g.classList.add("hide"))});b.appendChild(g);b.appendChild(d);c.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(h);c.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(b);c.controls={spinner:f.querySelector("h3 .spinner"),publicTransportation:f.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:f.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:f.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),
airQuality:f.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:f.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};f.classList.remove("hide");f.querySelectorAll(".btn-toggle").forEach(l=>{const a=l.dataset;a.set&&(m[a.set]={app:null,watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},a.source&&(k(a.source,()=>{m[a.set].loaded=!0;m[a.set].app.fetch()?(m[a.set].hasData=!0,m[a.set].app.init()):
c.controls[a.set].setAttribute("disabled","disabled")}),l.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[a.set].checked?m[a.set].app.show():m[a.set].app.hide();c.controls.spinner.classList.add("hide")})),"trafficLayer"===a.set&&l.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[a.set].checked?(m[a.set].app=new google.maps.TrafficLayer,m[a.set].app.setMap(c.ref),m[a.set].visible=!0):(m[a.set].visible=!1,m[a.set].app.setMap(null),
m[a.set].app=null);c.controls.spinner.classList.add("hide")}))})}});n.add("renderMap",()=>{const f=document.querySelector("#map");if(f){var b=f.dataset;b.bind&&(b=JSON.parse(atob(b.bind)),k(b.url,()=>{c.ref=new google.maps.Map(f,{center:c.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",
elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},
{visibility:"on"}]}]});google.maps.event.addListenerOnce(c.ref,"tilesloaded",()=>{c.loaded=!0;n.fire("mapRenderControls")})}))}});n.fire("renderMap")}}})();(()=>{app.render()})();
