/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(k,n){this.items[k]||(this.items[k]={name:k,callback:[]});this.items[k].callback.push(n)}fireAll(){for(let k in this.items)this.fire(k)}clearAll(k){this.items[k]={name:k,callback:[]}}fire(k){if(this.items[k])for(let n in this.items[k].callback)this.items[k].callback[n]()}}
const app=(()=>{function k(d,a,h){let g=document.getElementsByTagName("script")[0],f=document.createElement("script");void 0!==a&&null!==a&&(f.onreadystatechange=()=>{if("loaded"===f.readyState||"complete"===f.readyState)f.onreadystatechange=null,a(h)},f.onload=()=>{a(h)});f.setAttribute("src",d);f.setAttribute("defer","");g.parentNode.appendChild(f)}const n=new Observer,m={},b={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},loaded:!1,popup:null,controls:{},direction:{loaded:!1,service:null,renderer:null}},
e={app:null,watcher:null,visible:!1,updated:null,location:{lat:0,lng:0}};return{cdn:"https://iasi.digital/assets/",events:n,map:b,me:e,dataSets:m,dateDiff:function(d,a=!1){let h=d.split(/\D/);d=new Date;a&&(d=new Date(d.getTime()+6E4*d.getTimezoneOffset()));a=new Date(h[0],h[1]-1,h[2],h[3],h[4],h[5]);if(isNaN(d)||isNaN(a))return null;a=Math.abs(d.getTime()-a.getTime());return Math.floor(a/1E3/60)},api:async function(d,a="GET",h="",g={}){h={method:a,mode:"cors",cache:"no-cache",credentials:"same-origin",
headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},g),body:h?JSON.stringify(h):""};"GET"!==a&&"HEAD"!==a||delete h.body;return await fetch(d,h)},route:function(){const d=["route","method","query"];var a=window.location.pathname;const h=window.location.hash,g={};if(a&&(a=a.replace(/^\/?|\/?$/g,"").split("/"),0<a.length))for(let f=0;f<d.length;f++)g[d[f]]=a[f];h&&(g.hash=h.substring(1));return g},notify:function(d,a="error",h=0,g=!0){const f=document.querySelector(".notification-floating-placeholder");
if(f){const c=f.querySelectorAll(".notification"),l=document.createElement("p");l.classList.add("notification","notification-sm");l.classList.remove("error","success","info","warning");l.classList.add(a);l.innerHTML=d;g?(l.classList.add("notification-floating","notification-animation"),0<c.length&&(l.style.bottom=`${45*c.length+20}px`)):0<c.length&&(f.innerHTML="");f.appendChild(l);0<h&&setTimeout(()=>{l.classList.remove("notification","notification-sm","notification-inline","notification-animation",
"notification-floating","error","success","info","warning");l.innerHTML="";l.parentNode.removeChild(l)},1E3*h)}},render:function(){n.add("initiateDirectionService",()=>{b.loaded&&(null===b.direction.service&&(b.direction.service=new google.maps.DirectionsService),null===b.direction.renderer&&(b.direction.renderer=new google.maps.DirectionsRenderer,b.direction.renderer.setMap(b.ref)),b.direction.loaded=!0)});n.add("mapRenderControls",()=>{const d=document.querySelector(".mapControls");if(d&&b.loaded){const h=
document.createElement("div");var a=document.createElement("button");a.classList.add("mapCustomControl");a.innerHTML='<span data-icon="&#xe013;"></span>';a.title="Centreaz\u0103 harta pe Municipiul Ia\u0219i";a.type="button";a.addEventListener("click",f=>{f.preventDefault();f.stopPropagation();0<b.mapCenter.lat&&0<b.mapCenter.lng&&b.ref.panTo(new google.maps.LatLng(b.mapCenter.lat,b.mapCenter.lng))});h.appendChild(a);a=document.createElement("div");const g=document.createElement("button");g.setAttribute("data-state",
"hideLocation");g.classList.add("mapCustomControl","separator");g.innerHTML='<span data-icon="&#xe015;"></span>';g.title="Afi\u0219eaz\u0103/Ascunde loca\u021bia mea";g.type="button";g.addEventListener("click",f=>{f.preventDefault();f.stopPropagation();navigator.geolocation?"hideLocation"===g.getAttribute("data-state")?(g.setAttribute("data-state","showLocation"),g.classList.add("selected"),n.fire("initiateDirectionService"),e.watcher=navigator.geolocation.watchPosition(c=>{const l=c.coords.latitude;
c=c.coords.longitude;e.location.lat=l;e.location.lng=c;null===e.app&&(e.app=new google.maps.Marker({position:{lat:parseFloat(l),lng:parseFloat(c)},map:app.map.ref,title:"Loca\u021bia mea",icon:{url:"https://iasi.digital/assets/pin/me.png",size:new google.maps.Size(28,44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),e.app.setMap(b.ref));e.app.setPosition(new google.maps.LatLng(l,c));e.lastUpdate=(new Date).getTime();e.visible=!0;b.ref.panTo(new google.maps.LatLng(l,
c))},()=>{null!==e.app&&(e.app.setMap(null),e.app=null);null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null);e.lastUpdate=null;e.visible=!1;e.location.lat=0;e.location.lng=0},{enableHighAccuracy:!0,timeout:5E3})):(g.setAttribute("data-state","hideLocation"),g.classList.remove("selected"),null!==e.app&&(e.app.setMap(null),e.app=null),null!==e.watcher&&(navigator.geolocation.clearWatch(e.watcher),e.watcher=null),e.lastUpdate=null,e.visible=!1,e.location.lat=0,e.location.lng=
0):(g.setAttribute("data-state","hideLocation"),g.classList.remove("selected"),g.setAttribute("disabled","disabled"))});a.appendChild(g);b.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(h);b.ref.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a);b.controls={spinner:d.querySelector("h3 .spinner"),publicTransportation:d.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:d.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),
trafficLayer:d.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:d.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:d.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]')};d.classList.remove("hide");d.querySelectorAll(".btn-toggle").forEach(f=>{const c=f.dataset;c.set&&(m[c.set]={app:null,watcher:null,loaded:!1,visible:!1,hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},c.source&&
(k(c.source,()=>{m[c.set].loaded=!0;m[c.set].app.fetch()?(m[c.set].hasData=!0,m[c.set].app.init()):b.controls[c.set].setAttribute("disabled","disabled")}),f.addEventListener("click",()=>{b.controls.spinner.classList.remove("hide");b.controls[c.set].checked?m[c.set].app.show():m[c.set].app.hide();b.controls.spinner.classList.add("hide")})),"trafficLayer"===c.set&&f.addEventListener("click",()=>{b.controls.spinner.classList.remove("hide");b.controls[c.set].checked?(m[c.set].app=new google.maps.TrafficLayer,
m[c.set].app.setMap(b.ref),m[c.set].visible=!0):(m[c.set].visible=!1,m[c.set].app.setMap(null),m[c.set].app=null);b.controls.spinner.classList.add("hide")}))})}});n.add("renderMap",()=>{const d=document.querySelector("#map");if(d){var a=d.dataset;a.bind&&(a=JSON.parse(atob(a.bind)),k(a.url,()=>{b.ref=new google.maps.Map(d,{center:b.mapCenter,zoom:14,streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},
{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",
stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},{visibility:"on"}]}]});google.maps.event.addListenerOnce(b.ref,"tilesloaded",()=>{b.loaded=!0;n.fire("mapRenderControls")})}))}});n.fire("renderMap")}}})();(()=>{app.render()})();
