/*
 (c) Iasi Digital [https://iasi.digital]
*/
class Observer{constructor(){this.items=[]}add(g,k){this.items[g]||(this.items[g]={name:g,callback:[]});this.items[g].callback.push(k)}fireAll(){for(let g in this.items)this.fire(g)}clearAll(g){this.items[g]={name:g,callback:[]}}fire(g){if(this.items[g])for(let k in this.items[g].callback)this.items[g].callback[k]()}}
const app=(()=>{function g(e,d,a){let h=document.getElementsByTagName("script")[0],f=document.createElement("script");void 0!==d&&null!==d&&(f.onreadystatechange=()=>{if("loaded"===f.readyState||"complete"===f.readyState)f.onreadystatechange=null,d(a)},f.onload=()=>{d(a)});f.setAttribute("src",e);f.setAttribute("defer","");h.parentNode.appendChild(f)}const k=new Observer,b={},c={ref:null,mapCenter:{lat:47.1553424,lng:27.585645},myLocation:{lat:0,lng:0},loaded:!1,popup:null,controls:{}};return{cdn:"https://iasi.digital/assets/",
events:k,map:c,dataSets:b,dateDiff:function(e,d=!1){let a=e.split(/\D/);e=new Date;d&&(e=new Date(e.getTime()+6E4*e.getTimezoneOffset()));d=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5]);if(isNaN(e)||isNaN(d))return null;d=Math.abs(e.getTime()-d.getTime());return Math.floor(d/1E3/60)},api:async function(e,d="GET",a="",h={}){a={method:d,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:Object.assign({Accept:"application/json","Content-Type":"application/json"},h),body:a?JSON.stringify(a):""};
"GET"!==d&&"HEAD"!==d||delete a.body;return await fetch(e,a)},route:function(){const e=["route","method","query"];var d=window.location.pathname;const a=window.location.hash,h={};if(d&&(d=d.replace(/^\/?|\/?$/g,"").split("/"),0<d.length))for(let f=0;f<e.length;f++)h[e[f]]=d[f];a&&(h.hash=a.substring(1));return h},render:function(){k.add("mapRenderControls",()=>{const e=document.querySelector(".mapControls");e&&c.loaded&&(c.controls={spinner:e.querySelector("h3 .spinner"),myLocation:e.querySelector('input[type=checkbox][name="toggle.myLocation"]'),
myLocationPrecise:e.querySelector(".btn-precise-location"),publicTransportation:e.querySelector('input[type=checkbox][name="toggle.mobility.publicTransportation"]'),publicParking:e.querySelector('input[type=checkbox][name="toggle.mobility.publicParking"]'),trafficLayer:e.querySelector('input[type=checkbox][name="toggle.mobility.trafficLayer"]'),airQuality:e.querySelector('input[type=checkbox][name="toggle.environment.airQuality"]'),wasteCollection:e.querySelector('input[type=checkbox][name="toggle.environment.wasteCollection"]'),
wasteCollectionPoints:e.querySelector('input[type=checkbox][name="toggle.environment.wasteCollectionPoints"]')},e.classList.remove("hide"),c.controls.myLocationPrecise&&c.controls.myLocationPrecise.addEventListener("click",d=>{d.preventDefault();d.stopPropagation();0<c.myLocation.lat&&0<c.myLocation.lng&&c.ref.panTo(new google.maps.LatLng(c.myLocation.lat,c.myLocation.lng))}),e.querySelectorAll(".btn-toggle").forEach(d=>{const a=d.dataset;a.set&&(b[a.set]={app:null,watcher:null,loaded:!1,visible:!1,
hasData:!1,updated:null,data:{},markers:[],selectedMarker:null},a.source&&(g(a.source,()=>{b[a.set].loaded=!0;b[a.set].app.fetch()?(b[a.set].hasData=!0,b[a.set].app.init()):c.controls[a.set].setAttribute("disabled","disabled")}),d.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[a.set].checked?b[a.set].app.show():b[a.set].app.hide();c.controls.spinner.classList.add("hide")})),"trafficLayer"===a.set?d.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");
c.controls[a.set].checked?(b[a.set].app=new google.maps.TrafficLayer,b[a.set].app.setMap(c.ref),b[a.set].visible=!0):(b[a.set].visible=!1,b[a.set].app.setMap(null),b[a.set].app=null);c.controls.spinner.classList.add("hide")}):"myLocation"===a.set&&(navigator.geolocation?d.addEventListener("click",()=>{c.controls.spinner.classList.remove("hide");c.controls[a.set].checked?(c.controls.myLocationPrecise.classList.remove("hide"),b[a.set].watcher=navigator.geolocation.watchPosition(h=>{const f=h.coords.latitude;
h=h.coords.longitude;c.myLocation.lat=f;c.myLocation.lng=h;null===b[a.set].app&&(b[a.set].app=new google.maps.Marker({position:{lat:parseFloat(f),lng:parseFloat(h)},map:app.map.ref,title:"Loca\u021bia mea",icon:{url:"https://iasi.digital/assets/pin/me.png",size:new google.maps.Size(28,44),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,22),scaledSize:new google.maps.Size(28,44)}}),b[a.set].app.setMap(c.ref));b[a.set].app.setPosition(new google.maps.LatLng(f,h));b[a.set].lastUpdate=
(new Date).getTime();b[a.set].visible=!0},()=>{c.controls[a.set].checked=!1;null!==b[a.set].app&&(b[a.set].app.setMap(null),b[a.set].app=null);null!==b[a.set].watcher&&(navigator.geolocation.clearWatch(b[a.set].watcher),b[a.set].watcher=null);b[a.set].lastUpdate=null;b[a.set].visible=!1;c.myLocation.lat=0;c.myLocation.lng=0;c.controls.myLocationPrecise.classList.add("hide")},{enableHighAccuracy:!0,timeout:5E3})):(null!==b[a.set].app&&(b[a.set].app.setMap(null),b[a.set].app=null),null!==b[a.set].watcher&&
(navigator.geolocation.clearWatch(b[a.set].watcher),b[a.set].watcher=null),b[a.set].lastUpdate=null,b[a.set].visible=!1,c.myLocation.lat=0,c.myLocation.lng=0,c.controls.myLocationPrecise.classList.add("hide"));c.controls.spinner.classList.add("hide")}):c.controls[a.set].setAttribute("disabled","disabled")))}))});k.add("renderMap",()=>{const e=document.querySelector("#map");if(e){var d=e.dataset;d.bind&&(d=JSON.parse(atob(d.bind)),g(d.url,()=>{c.ref=new google.maps.Map(e,{center:c.mapCenter,zoom:14,
streetViewControl:!1,mapTypeControl:!1,fullscreenControl:!1,styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",
stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{color:"#b4d4e1"},{visibility:"on"}]}]});google.maps.event.addListenerOnce(c.ref,"tilesloaded",()=>{c.loaded=!0;k.fire("mapRenderControls")})}))}});k.fire("renderMap")}}})();(()=>{app.render()})();
