/*
 (c) 2018-2025. Iasi Digital [https://iasi.digital]
*/
class PublicParking extends DataSet{constructor(){super();this.parkingMapping={82:"Moldova",83:"Mitoc",84:"Prim\u0103ria Ia\u0219i",85:"Prefectura Ia\u0219i",86:"Prim\u0103verii",87:"Podu Ro\u0219u",88:"Teatru",89:"Victoria",90:"Hala Central\u0103",91:"Independen\u021bei",92:"Golia",93:"Casa Studen\u021bilor",94:"Anastasie Panu"};this.dataSetFilter="64dc-92f1-4b56-9071-1313/22d1082403b780c66b2687f43de783a10c16";this.cluster=null;this.clusterMarkers=[];this.clusterImage='<svg fill="#4cacf6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><circle cx="120" cy="120" opacity="1" r="70"></circle><circle cx="120" cy="120" opacity=".7" r="90"></circle><circle cx="120" cy="120" opacity=".3" r="110"></circle><circle cx="120" cy="120" opacity=".2" r="130"></circle></svg>';
this.selectedMarker=null}init(){this.setWatcher(3E5,()=>{this.getData()});CityApp.load("https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js")}getData(b=null){return PublicParking.fetch(this.dataSetFilter,a=>{this.data=a;b&&b()})}render(b){this.hasData()?(this.data.forEach(a=>{var c=document.createElement("div");c.innerText="P";c=new google.maps.marker.PinElement({glyphColor:"#fff",background:2===parseInt(a.stare)?"#f64c4c":"#4cacf6",borderColor:2===parseInt(a.stare)?"#e83636":"#3893d9",
glyph:c});this.markers[a.sensorId]?this.markers[a.sensorId].state!==a.stare&&(this.markers[a.sensorId]._ref.content=c.element,this.markers[a.sensorId].state=entry.stare,this.markers[a.sensorId].dateUpdated=Date.now()):(c=new google.maps.marker.AdvancedMarkerElement({position:{lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},title:a.numar.toString(),content:c.element}),this.markers[a.sensorId]={id:a.sensorId,parkingId:a.parkingId,number:a.numar,state:a.stare,_ref:c,dateUpdated:Date.now(),isVisible:!1},
this.clusterMarkers.push(c),this.markers[a.sensorId]._ref.addListener("click",()=>{this.selectedMarker=this.markers[a.sensorId]._ref;CityApp.mapUtils("closePopup");CityApp.mapUtils("createPopup",{title:1===this.markers[a.sensorId].state?CityApp.config.labels["parking.parkingFree"]:CityApp.config.labels["parking.parkingOccupied"],titleLabel:"P",titleLabelClass:["parking",`parking-${this.markers[a.sensorId].state}`],content:`<ul><li>${CityApp.config.labels["parking.name"]}: ${PublicParking.parkingMapping[this.markers[a.sensorId].parkingId]}</li><li>${CityApp.config.labels["parking.number"]}: ${this.markers[a.sensorId].number}</li></ul><nav><a href="https://www.waze.com/ul?ll=${parseFloat(a.latitude)}%2C${parseFloat(a.longitude)}&navigate=yes&zoom=17" target="_blank" class="btn btn-default btn-sm"><span class="ic-mr-5" data-icon="&#xe023;"></span> ${CityApp.config.labels["parking.deepLinkWaze"]}</a><a href="https://www.google.com/maps/dir/?api=1&travelmode=driving&dir_action=navigate&destination=${parseFloat(a.latitude)}%2C${parseFloat(a.longitude)}" target="_blank" class="btn btn-default btn-sm"><span class="ic-mr-5" data-icon="&#xe02a;"></span> ${CityApp.config.labels["parking.deepLinkMaps"]}</a></nav>`,
onClose:()=>{this.selectedMarker=null}});CityApp.mapUtils("openPopup",{ref:this.markers[a.sensorId]._ref})}))}),this.metrics.parkingFree=this.data.filter(a=>1===a.stare).length,this.metrics.parkingOccupied=this.data.length-this.metrics.parkingFree):this.getData(()=>{this.render()})}show(b=null){this.hasData()?(this.render(),void 0!==markerClusterer&&void 0!==markerClusterer.MarkerClusterer&&null===this.cluster&&(this.cluster=new markerClusterer.MarkerClusterer({map:CityApp.data.map._ref,markers:this.clusterMarkers})),
this.setWatcher(18E4,()=>{this.getData(()=>{this.render()})}),this.isVisible=!0,b&&b()):this.getData(()=>{setTimeout(()=>{this.show()},1E3)})}hide(b=null){this.isVisible=!1;this.setWatcher(3E5,()=>{this.getData()});this.cluster&&(this.cluster.clearMarkers(),this.cluster=null);b&&b()}}(()=>{CityApp.data.sets.publicParking=new PublicParking})();
