/*
 (c) 2018-2025. Iasi Digital [https://iasi.digital]
*/
class WasteCollectorVehicle{constructor(b){this.id=b.VehicleId||0;this.label=b.PlateNumber||null;this.lastUpdate=b.LastRecordDT;this.lastUpdateFriendly=CityApp.dateDiff(this.lastUpdate,!0);this.latitude=b.LastLatitude;this.longitude=b.LastLongitude}}
class WasteCollection extends DataSet{constructor(){super();this.dataSet="f8d1-1eb9-460b-85f8-0e18";this.selectedMarker=null}init(){this.setWatcher(6E4,()=>{this.getData()})}getData(b=null){return WasteCollection.fetch(this.dataSet,c=>{this.data=c;b&&b()})}render(b){this.hasData()?this.data.forEach(c=>{const a=new WasteCollectorVehicle(c);a.latitude&&a.longitude&&(this.markers[a.id]?(this.markers[a.id]._ref.position={lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},!this.markers[a.id].isVisible&&
this.markers[a.id]._ref&&(this.markers[a.id]._ref.setMap(CityApp.data.map._ref),this.markers[a.id].isVisible=!0)):(c=document.createElement("div"),c.innerText="\u267a",c.style.fontSize="16px",c=new google.maps.marker.PinElement({glyphColor:"#fff",background:"#97b534",borderColor:"#97b534",glyph:c}),c=new google.maps.marker.AdvancedMarkerElement({position:{lat:parseFloat(a.latitude),lng:parseFloat(a.longitude)},map:CityApp.data.map._ref,title:a.label,content:c.element}),this.markers[a.id]={id:a.id,
_ref:c,isVisible:!0},this.markers[a.id]._ref.addListener("click",()=>{this.selectedMarker=this.markers[a.id]._ref;CityApp.mapUtils("closePopup");CityApp.mapUtils("createPopup",{title:a.label,content:`<h6>${CityApp.config.labels["wasteCollection.lastUpdate"]}</h6><p>${(new Date(a.lastUpdate)).toLocaleString("ro-RO",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})}</p>`,onClick:()=>{this.selectedMarker=null}});CityApp.mapUtils("openPopup",{ref:this.markers[a.id]._ref})})))}):
this.getData(()=>{this.render()})}show(b=null){this.hasData()?(this.render(),this.setWatcher(3E4,()=>{this.getData(()=>{this.render()})}),this.isVisible=!0):this.getData(()=>{setTimeout(()=>{this.show()},1E3)});b&&b()}hide(b=null){Object.values(this.markers).forEach(c=>{c._ref&&(c._ref.setMap(null),c.isVisible=!1)});this.isVisible=!1;this.setWatcher(6E4,()=>{this.getData()});b&&b()}}(()=>{CityApp.data.sets.wasteCollection=new WasteCollection})();
